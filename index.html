<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Learning Hub - Enhanced Edition</title>
    <meta name="description" content="Advanced AI Learning Platform with Real-time Collaboration">
    <meta name="keywords" content="AI, machine learning, collaboration, projects, learning">
    <meta property="og:title" content="AI Learning Hub">
    <meta property="og:description" content="Advanced AI Learning Platform">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%237C3AED'/%3E%3Ctext x='16' y='20' text-anchor='middle' fill='white' font-size='16' font-family='Arial'%3EAI%3C/text%3E%3C/svg%3E">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root {
            --primary: #7c3aed;
            --secondary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --text: #e2e8f0;
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.8);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-size: 16px;
        }
        
        [data-theme="light"] {
            --primary: #6d28d9;
            --secondary: #2563eb;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --dark: #f1f5f9;
            --light: #1e293b;
            --text: #334155;
            --bg-dark: #ffffff;
            --bg-card: rgba(241, 245, 249, 0.9);
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--dark) 100%);
            min-height: 100vh;
            overflow-x: hidden;
            transition: var(--transition);
        }
        
        /* Enhanced Navigation with Mobile Menu */
        nav {
            position: fixed;
            top: 0;
            width: 100%;
            background: var(--dark);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            z-index: 9999;
            transition: var(--transition);
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 2rem;
            gap: 2rem;
        }
        
        .logo {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            cursor: pointer;
            transition: transform 0.3s;
            white-space: nowrap;
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            padding: 5px;
        }
        
        .mobile-menu-toggle span {
            width: 25px;
            height: 3px;
            background: var(--text);
            transition: var(--transition);
        }
        
        .mobile-menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .mobile-menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }
        
        .mobile-menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }
        
        /* Navigation Links */
        .nav-links {
            display: flex;
            gap: 0.5rem;
            list-style: none;
            align-items: center;
        }
        
        .nav-links button {
            padding: 0.6rem 1.2rem;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--text);
            transition: var(--transition);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .nav-links button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .nav-links button:hover::before {
            left: 100%;
        }
        
        .nav-links button:hover {
            background: rgba(124, 58, 237, 0.2);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .nav-links button.active {
            background: var(--primary);
            color: white;
            font-weight: bold;
            border-color: var(--primary);
        }
        
        /* User Actions */
        .user-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Theme Toggle */
        .theme-toggle {
            background: transparent;
            border: 2px solid var(--text);
            border-radius: 2rem;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            width: 40px;
            height: 40px;
        }
        
        .theme-toggle:hover {
            background: rgba(124, 58, 237, 0.2);
            border-color: var(--primary);
            transform: rotate(180deg);
        }
        
        /* Notification Bell */
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .skeleton-card {
            height: 200px;
            border-radius: 1rem;
            margin-bottom: 1rem;
        }
        
        /* Enhanced Cards with Animation */
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(124,58,237,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(124,58,237,0.3);
        }
        
        /* Enhanced Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active::after {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            pointer-events: none;
        }
        
        .toast {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
            pointer-events: auto;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .toast:hover {
            transform: translateX(-10px);
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        .toast.info {
            border-left: 4px solid var(--primary);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Progress Bar */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            z-index: 10000;
            transition: width 0.3s ease;
        }
        
        /* User Profile Card */
        .user-profile-card {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            margin: 0 auto 1rem;
            position: relative;
        }
        
        .user-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 15px;
            height: 15px;
            background: var(--success);
            border-radius: 50%;
            border: 2px solid var(--bg-card);
        }
        
        /* Rich Text Editor */
        .rich-editor {
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .editor-toolbar {
            background: rgba(0,0,0,0.2);
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .editor-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .editor-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .editor-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .editor-content {
            min-height: 200px;
            padding: 1rem;
            color: var(--text);
            outline: none;
        }
        
        /* Search Filters */
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .filter-tag {
            padding: 0.25rem 0.75rem;
            background: rgba(124,58,237,0.2);
            color: var(--primary);
            border-radius: 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }
        
        .filter-tag:hover {
            background: var(--primary);
            color: white;
        }
        
        .filter-tag.active {
            background: var(--primary);
            color: white;
            border-color: white;
        }
        
        /* Activity Feed */
        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-left: 2px solid var(--primary);
            position: relative;
            transition: var(--transition);
        }
        
        .activity-item:hover {
            background: rgba(124,58,237,0.1);
            padding-left: 1.5rem;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-time {
            color: var(--text);
            opacity: 0.6;
            font-size: 0.875rem;
        }
        
        /* Accessibility Focus Indicators */
        *:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Skip to main content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            text-decoration: none;
            z-index: 10001;
        }
        
        .skip-link:focus {
            top: 0;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
            }
            
            .nav-links {
                position: fixed;
                top: 60px;
                left: -100%;
                width: 100%;
                height: calc(100vh - 60px);
                background: var(--dark);
                flex-direction: column;
                padding: 2rem;
                transition: left 0.3s ease;
            }
            
            .nav-links.active {
                left: 0;
            }
            
            .nav-links button {
                width: 100%;
                text-align: left;
            }
            
            .user-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .grid {
                grid-template-columns: 1fr !important;
            }
            
            .toast-container {
                left: 20px;
                right: 20px;
            }
            
            .modal-content {
                width: 95% !important;
                margin: 1rem !important;
            }
        }
        
        /* Grid System */
        .grid {
            display: grid;
            gap: 2rem;
        }
        
        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        
        @media (max-width: 640px) {
            .grid-cols-2, .grid-cols-3, .grid-cols-4 { grid-template-columns: repeat(1, 1fr); }
        }
        
        @media (min-width: 641px) and (max-width: 1024px) {
            .grid-cols-3, .grid-cols-4 { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Modal Enhancement */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 150px;
            z-index: 2000;
            animation: fadeIn 0.3s;
            overflow-y: auto;
        }
        
        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            padding-top: 3.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            position: relative;
            margin-bottom: 2rem;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--danger);
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .modal-close {
                right: 10px;
            }
        }
        
        .modal-close:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Page Sections */
        .page-section {
            display: none;
            min-height: 100vh;
            padding-top: 120px;
            animation: fadeIn 0.5s ease;
        }
        
        .page-section.active {
            display: block;
        }
        
        /* Forms Enhancement */
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.5rem;
            color: var(--text);
            font-size: 0.95rem;
            transition: var(--transition);
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary);
            background: rgba(124,58,237,0.05);
        }
        
        .form-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 0.25rem;
            font-size: 1.5rem;
        }
        
        .star {
            cursor: pointer;
            color: rgba(255,255,255,0.3);
            transition: var(--transition);
        }
        
        .star:hover,
        .star.active {
            color: var(--warning);
        }
        
        /* Bookmark Button */
        .bookmark-btn {
            background: transparent;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text);
        }
        
        .bookmark-btn:hover {
            color: var(--primary);
            transform: scale(1.2);
        }
        
        .bookmark-btn.bookmarked {
            color: var(--warning);
        }
    </style>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Progress Bar -->
    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Floating Messages Widget -->
    <div id="floating-messages" style="position: fixed; bottom: 20px; right: 20px; z-index: 1500;">
        <div id="messages-widget-minimized" style="display: block;">
            <button onclick="toggleMessagesWidget()" 
                    style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary); 
                           color: white; border: none; font-size: 1.5rem; cursor: pointer; 
                           box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.3s;">
                üí¨
                <span id="messages-badge" style="position: absolute; top: -5px; right: -5px; 
                                                  background: var(--danger); color: white; border-radius: 50%; 
                                                  width: 20px; height: 20px; font-size: 0.75rem; 
                                                  display: none; align-items: center; justify-content: center;">0</span>
            </button>
        </div>
        
        <div id="messages-widget-expanded" style="display: none; width: 350px; height: 500px; 
                                                   background: var(--bg-card); border-radius: 1rem; 
                                                   box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="background: var(--primary); color: white; padding: 1rem; 
                        display: flex; justify-content: between; align-items: center;">
                <h3 style="margin: 0; flex: 1;">Messages</h3>
                <button onclick="toggleMessagesWidget()" 
                        style="background: transparent; border: none; color: white; 
                               font-size: 1.25rem; cursor: pointer;">√ó</button>
            </div>
            
            <div style="display: flex; height: calc(100% - 60px);">
                <!-- Conversations List -->
                <div id="widget-conversations" style="width: 120px; background: rgba(0,0,0,0.2); 
                                                      overflow-y: auto; border-right: 1px solid rgba(255,255,255,0.1);">
                </div>
                
                <!-- Chat Area -->
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <div id="widget-chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem;">
                        <p style="text-align: center; color: var(--text); opacity: 0.6;">Select a conversation</p>
                    </div>
                    
                    <div id="widget-chat-input" style="padding: 1rem; border-top: 1px solid rgba(255,255,255,0.1); display: none;">
                        <input type="text" id="widget-message-input" placeholder="Type a message..." 
                               style="width: 100%; padding: 0.5rem; background: rgba(255,255,255,0.05); 
                                      border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; 
                                      color: var(--text);"
                               onkeypress="if(event.key==='Enter') sendWidgetMessage()">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation -->
    <nav role="navigation" aria-label="Main navigation">
        <div class="nav-container">
            <div class="logo" onclick="navigateTo('home')" role="button" tabindex="0" aria-label="AI Learning Hub Home">
                <span>üß†</span>
                <span style="white-space: nowrap;">AI Learning Hub</span>
            </div>
            
            <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle navigation menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <div class="nav-links" id="nav-links">
                <button onclick="navigateTo('home')" class="active" id="nav-home" aria-label="Home">Home</button>
                <button onclick="navigateTo('projects')" id="nav-projects" aria-label="Projects">Projects</button>
                <button onclick="navigateTo('lessons')" id="nav-lessons" aria-label="Lessons">Lessons</button>
                <button onclick="navigateTo('discussions')" id="nav-discussions" aria-label="Discussions">Discussions</button>
                <button onclick="navigateTo('collaborate')" id="nav-collaborate" aria-label="Collaborate">Collaborate</button>
                <button onclick="navigateTo('profile')" id="nav-profile" aria-label="Profile">Profile</button>
                <button onclick="navigateTo('friends')" id="nav-friends" aria-label="Friends">Friends</button>
            </div>
            
            <div class="user-actions">
                <button class="theme-toggle" onclick="showGlobalSearch()" aria-label="Global Search" title="Alt+S">
                    üîç
                </button>
                
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span id="theme-icon">üåô</span>
                </button>
                
                <button class="theme-toggle" onclick="startPomodoro()" aria-label="Pomodoro Timer">
                    üçÖ
                </button>
                
                <button class="theme-toggle" onclick="showCalendar()" aria-label="Calendar">
                    üìÖ
                </button>
                
                <button class="theme-toggle" onclick="showNotifications()" aria-label="Notifications" style="position: relative;">
                    üîî
                    <span class="notification-badge" id="notification-count" style="position: absolute; top: -5px; right: -5px;">3</span>
                </button>
                
                <div class="dropdown" style="position: relative; display: inline-block;">
                    <button class="theme-toggle" onclick="toggleSettingsMenu()" aria-label="Settings">
                        ‚öôÔ∏è
                    </button>
                    <div id="settings-dropdown" style="display: none; position: absolute; right: 0; top: 100%; 
                                                       background: var(--bg-card); border-radius: 0.5rem; 
                                                       box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; 
                                                       min-width: 200px; margin-top: 0.5rem;">
                        <div style="padding: 0.5rem;">
                            <button class="dropdown-item" onclick="showAnalyticsDashboard(); toggleSettingsMenu();"
                                    style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; 
                                           border: none; color: var(--text); cursor: pointer;">
                                üìä Analytics
                            </button>
                            <button class="dropdown-item" onclick="showPrivacySettings(); toggleSettingsMenu();"
                                    style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; 
                                           border: none; color: var(--text); cursor: pointer;">
                                üîí Privacy
                            </button>
                            <button class="dropdown-item" onclick="showCustomThemes(); toggleSettingsMenu();"
                                    style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; 
                                           border: none; color: var(--text); cursor: pointer;">
                                üé® Themes
                            </button>
                            <button class="dropdown-item" onclick="showAccessibilityMenu(); toggleSettingsMenu();"
                                    style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; 
                                           border: none; color: var(--text); cursor: pointer;">
                                ‚ôø Accessibility
                            </button>
                            <button class="dropdown-item" onclick="showKeyboardShortcuts(); toggleSettingsMenu();"
                                    style="width: 100%; text-align: left; padding: 0.75rem; background: transparent; 
                                           border: none; color: var(--text); cursor: pointer;">
                                ‚å®Ô∏è Shortcuts
                            </button>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="auth-btn" onclick="showAuthModal()">Sign In</button>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main id="main-content">
        <!-- Home Page -->
        <section id="home" class="page-section active" role="main" aria-label="Home section">
            <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 4rem 2rem; text-align: center; margin-top: -120px; padding-top: 10rem;">
                <h1 style="font-size: 3rem; margin-bottom: 1rem; animation: fadeInUp 0.5s;">Welcome to AI Learning Hub</h1>
                <p style="font-size: 1.25rem; margin-bottom: 2rem; opacity: 0.9; animation: fadeInUp 0.7s;">
                    Next-Generation Learning Platform with Real-time Collaboration
                </p>
                <div style="animation: fadeInUp 0.9s;">
                    <button class="btn" style="background: white; color: var(--primary); font-size: 1.1rem; padding: 1rem 2rem;" onclick="navigateTo('projects')">
                        üöÄ Explore Projects
                    </button>
                </div>
            </div>
            
            <div style="padding: 3rem 2rem; max-width: 1200px; margin: 0 auto;">
                <!-- Activity Feed -->
                <div style="margin-bottom: 3rem;">
                    <h2 style="color: var(--text); margin-bottom: 1.5rem;">üìä Recent Activity</h2>
                    <div class="card">
                        <div id="activity-feed">
                            <div class="activity-item">
                                <div class="activity-icon">üë§</div>
                                <div class="activity-content">
                                    <strong>Alice Developer</strong> created a new project "AI Image Generator"
                                    <div class="activity-time">5 minutes ago</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">üí¨</div>
                                <div class="activity-content">
                                    <strong>Bob Builder</strong> commented on "Smart Task Automation"
                                    <div class="activity-time">1 hour ago</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">‚≠ê</div>
                                <div class="activity-content">
                                    <strong>Carol Charts</strong> starred "Data Visualization Dashboard"
                                    <div class="activity-time">2 hours ago</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Platform Features -->
                <div style="margin-top: 3rem;">
                    <h2 style="text-align: center; margin-bottom: 2rem; color: var(--text); font-size: 2rem;">
                        Platform Features
                    </h2>
                    
                    <div class="grid grid-cols-3">
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">üöÄ Advanced Projects</h3>
                            <p>Create, share, and collaborate on AI projects with version control and real-time updates</p>
                        </div>
                        
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">üë• User Profiles</h3>
                            <p>Build your portfolio, follow others, and track your learning journey</p>
                        </div>
                        
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">üåì Dark/Light Mode</h3>
                            <p>Choose your preferred theme for comfortable learning any time</p>
                        </div>
                        
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">üì± Mobile Responsive</h3>
                            <p>Learn on any device with our fully responsive design</p>
                        </div>
                        
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">üîî Real-time Updates</h3>
                            <p>Get instant notifications about comments, likes, and project updates</p>
                        </div>
                        
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">‚ôø Accessibility</h3>
                            <p>Built with WCAG standards for an inclusive learning experience</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Projects Page -->
        <section id="projects" class="page-section" role="main" aria-label="Projects section">
            <div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h1 style="color: var(--text);">üöÄ Community Projects</h1>
                    <button class="btn btn-primary" onclick="showCreateProjectModal()">
                        ‚ûï Create Project
                    </button>
                </div>
                
                <!-- Advanced Search and Filters -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <input type="text" id="project-search" placeholder="üîç Search projects..." 
                               style="flex: 1; min-width: 200px; padding: 0.75rem; background: rgba(255,255,255,0.05); 
                                      border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text);"
                               onkeyup="window.searchProjects(this.value)">
                        
                        <select id="category-filter" onchange="filterProjects()" 
                                style="padding: 0.75rem; background: #1e293b; 
                                       border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text);">
                            <option value="" style="background: #1e293b; color: white;">All Categories</option>
                            <option value="ai-ml" style="background: #1e293b; color: white;">ü§ñ AI/ML</option>
                            <option value="web-dev" style="background: #1e293b; color: white;">üåê Web Dev</option>
                            <option value="mobile" style="background: #1e293b; color: white;">üì± Mobile</option>
                            <option value="data-science" style="background: #1e293b; color: white;">üìä Data Science</option>
                        </select>
                        
                        <select id="sort-filter" onchange="sortProjects()" 
                                style="padding: 0.75rem; background: #1e293b; 
                                       border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text);">
                            <option value="recent" style="background: #1e293b; color: white;">Most Recent</option>
                            <option value="popular" style="background: #1e293b; color: white;">Most Popular</option>
                            <option value="active" style="background: #1e293b; color: white;">Most Active</option>
                        </select>
                    </div>
                    
                    <!-- Tech Stack Filters -->
                    <div class="filter-tags" id="tech-filters">
                        <span class="filter-tag" onclick="toggleTechFilter('Python')">Python</span>
                        <span class="filter-tag" onclick="toggleTechFilter('JavaScript')">JavaScript</span>
                        <span class="filter-tag" onclick="toggleTechFilter('React')">React</span>
                        <span class="filter-tag" onclick="toggleTechFilter('TensorFlow')">TensorFlow</span>
                        <span class="filter-tag" onclick="toggleTechFilter('Node.js')">Node.js</span>
                    </div>
                </div>
                
                <!-- Projects Grid with Loading State -->
                <div id="projects-grid" class="grid grid-cols-3">
                    <!-- Projects will be loaded here -->
                </div>
                
                <!-- Loading Skeleton -->
                <div id="projects-loading" style="display: none;">
                    <div class="grid grid-cols-3">
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                        <div class="skeleton skeleton-card"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- User Profile Page -->
        <section id="profile" class="page-section" role="main" aria-label="Profile section">
            <div style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
                <div class="grid grid-cols-3" style="gap: 2rem;">
                    <!-- Profile Sidebar -->
                    <div>
                        <div class="user-profile-card">
                            <div class="user-avatar online" id="profile-avatar">üë§</div>
                            <h2 id="profile-name" style="color: var(--text); margin-bottom: 0.5rem;">User Name</h2>
                            <p id="profile-bio" style="color: var(--text); opacity: 0.8; margin-bottom: 1rem;">
                                AI enthusiast and developer
                            </p>
                            
                            <div style="display: flex; justify-content: space-around; margin-bottom: 1rem; padding: 1rem 0; border-top: 1px solid rgba(255,255,255,0.1);">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);" id="project-count">0</div>
                                    <div style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Projects</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);" id="follower-count">0</div>
                                    <div style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Followers</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);" id="following-count">0</div>
                                    <div style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Following</div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;" onclick="editProfile()">
                                ‚úèÔ∏è Edit Profile
                            </button>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="showProjectStats()">
                                    üìä Statistics
                                </button>
                                <button class="btn btn-secondary" onclick="showAchievements()">
                                    üèÜ Achievements
                                </button>
                            </div>
                        </div>
                        
                        <!-- Skills -->
                        <div class="card" style="margin-top: 1rem;">
                            <h3 style="color: var(--text); margin-bottom: 1rem;">üéØ Skills</h3>
                            <div class="filter-tags">
                                <span class="filter-tag active">Python</span>
                                <span class="filter-tag active">Machine Learning</span>
                                <span class="filter-tag active">React</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile Content -->
                    <div style="grid-column: span 2;">
                        <!-- Profile Tabs -->
                        <div class="card" style="margin-bottom: 1rem;">
                            <div style="display: flex; gap: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                                <button class="btn btn-secondary" onclick="showProfileTab('projects')">üìÅ Projects</button>
                                <button class="btn btn-secondary" onclick="showProfileTab('starred')">‚≠ê Starred</button>
                                <button class="btn btn-secondary" onclick="showProfileTab('activity')">üìä Activity</button>
                                <button class="btn btn-secondary" onclick="showProfileTab('achievements')">üèÜ Achievements</button>
                            </div>
                        </div>
                        
                        <!-- Tab Content -->
                        <div id="profile-content">
                            <!-- User's projects, starred items, activity, etc. will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Lessons Page -->
        <section id="lessons" class="page-section" role="main" aria-label="Lessons section">
            <div style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <h1 style="color: var(--text);">üìö AI Learning Lessons</h1>
                    <button class="btn btn-primary" onclick="showCreateLessonModal()">
                        ‚ûï Create Lesson
                    </button>
                </div>
                
                <!-- Learning Resources Section -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem;">üìö Learning Resources</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <!-- Resource Library -->
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem;">
                            <h3 style="color: var(--secondary); font-size: 1.1rem; margin-bottom: 0.5rem;">
                                üìñ Resource Library
                            </h3>
                            <p style="font-size: 0.875rem; opacity: 0.8; margin-bottom: 1rem;">
                                Access curated learning materials
                            </p>
                            <button class="btn btn-secondary" onclick="showResourceLibrary()" style="width: 100%;">
                                Browse Resources
                            </button>
                        </div>
                        
                        <!-- Video Tutorials -->
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem;">
                            <h3 style="color: var(--secondary); font-size: 1.1rem; margin-bottom: 0.5rem;">
                                üé• Video Tutorials
                            </h3>
                            <p style="font-size: 0.875rem; opacity: 0.8; margin-bottom: 1rem;">
                                Watch expert-led video lessons
                            </p>
                            <button class="btn btn-secondary" onclick="showVideoTutorials()" style="width: 100%;">
                                Watch Videos
                            </button>
                        </div>
                        
                        <!-- Code Examples -->
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem;">
                            <h3 style="color: var(--secondary); font-size: 1.1rem; margin-bottom: 0.5rem;">
                                üíª Code Examples
                            </h3>
                            <p style="font-size: 0.875rem; opacity: 0.8; margin-bottom: 1rem;">
                                Real-world code snippets and projects
                            </p>
                            <button class="btn btn-secondary" onclick="showCodeExamples()" style="width: 100%;">
                                View Code
                            </button>
                        </div>
                        
                        <!-- External Links -->
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem;">
                            <h3 style="color: var(--secondary); font-size: 1.1rem; margin-bottom: 0.5rem;">
                                üîó External Resources
                            </h3>
                            <p style="font-size: 0.875rem; opacity: 0.8; margin-bottom: 1rem;">
                                Recommended external learning sites
                            </p>
                            <button class="btn btn-secondary" onclick="showExternalResources()" style="width: 100%;">
                                Explore Links
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Access Resources -->
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <h3 style="color: var(--text); margin-bottom: 1rem;">‚ö° Quick Access</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <a href="#" onclick="openResource('python-basics'); return false;" 
                               class="tech-tag" style="cursor: pointer;">Python Basics</a>
                            <a href="#" onclick="openResource('ml-fundamentals'); return false;" 
                               class="tech-tag" style="cursor: pointer;">ML Fundamentals</a>
                            <a href="#" onclick="openResource('deep-learning'); return false;" 
                               class="tech-tag" style="cursor: pointer;">Deep Learning</a>
                            <a href="#" onclick="openResource('data-science'); return false;" 
                               class="tech-tag" style="cursor: pointer;">Data Science</a>
                            <a href="#" onclick="openResource('neural-networks'); return false;" 
                               class="tech-tag" style="cursor: pointer;">Neural Networks</a>
                            <a href="#" onclick="openResource('nlp'); return false;" 
                               class="tech-tag" style="cursor: pointer;">NLP</a>
                            <a href="#" onclick="openResource('computer-vision'); return false;" 
                               class="tech-tag" style="cursor: pointer;">Computer Vision</a>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3">
                    <div class="card">
                        <h3 style="color: var(--primary);">üß† Introduction to AI</h3>
                        <p>Learn the fundamentals of artificial intelligence</p>
                        <div style="margin-top: 1rem;">
                            <span style="padding: 0.25rem 0.75rem; background: var(--success); color: white; border-radius: 1rem; font-size: 0.875rem;">
                                Beginner
                            </span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="color: var(--primary);">ü§ñ Machine Learning Basics</h3>
                        <p>Understanding ML algorithms and applications</p>
                        <div style="margin-top: 1rem;">
                            <span style="padding: 0.25rem 0.75rem; background: var(--warning); color: white; border-radius: 1rem; font-size: 0.875rem;">
                                Intermediate
                            </span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="color: var(--primary);">üé® Generative AI</h3>
                        <p>Create with AI: Images, text, and more</p>
                        <div style="margin-top: 1rem;">
                            <span style="padding: 0.25rem 0.75rem; background: var(--danger); color: white; border-radius: 1rem; font-size: 0.875rem;">
                                Advanced
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Discussions Page -->
        <section id="discussions" class="page-section" role="main" aria-label="Discussions section">
            <div style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
                <h1 style="color: var(--text); margin-bottom: 2rem;">üí¨ Community Discussions</h1>
                
                <button class="btn btn-primary" style="margin-bottom: 2rem;" onclick="showNewDiscussionModal()">
                    ‚ûï Start New Discussion
                </button>
                
                <div id="discussions-list">
                    <!-- Discussions will be loaded here -->
                </div>
            </div>
        </section>
        
        <!-- Friends Page -->
        <section id="friends" class="page-section" role="main" aria-label="Friends section">
            <div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
                <h1 style="color: var(--text); margin-bottom: 2rem;">üë• Friends & Network</h1>
                
                <!-- Friend Requests Section -->
                <div id="friend-requests-section" class="card" style="margin-bottom: 2rem; display: none;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">üì® Friend Requests</h3>
                    <div id="friend-requests-list"></div>
                </div>
                
                <!-- Search Users -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">üîç Find Friends</h3>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="user-search" placeholder="Search users by name..." 
                               style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.05); 
                                      border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text);"
                               onkeyup="searchUsers()">
                    </div>
                    <div id="user-search-results" style="margin-top: 1rem;"></div>
                </div>
                
                <!-- Friends List -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: var(--primary);">üë´ My Friends</h3>
                        <span id="friends-online-count" style="color: var(--success); font-size: 0.875rem;">0 online</span>
                    </div>
                    <div id="friends-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                        <!-- Friends will be loaded here -->
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Messages Page -->
        <section id="messages" class="page-section" role="main" aria-label="Messages section">
            <div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; height: calc(100vh - 120px);">
                    <!-- Conversations List -->
                    <div class="card" style="overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="color: var(--primary);">üí¨ Chats</h3>
                            <button class="btn btn-secondary" style="padding: 0.5rem;" onclick="createGroupChat()">
                                ‚ûï Group
                            </button>
                        </div>
                        <div id="conversations-list">
                            <!-- Conversations will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Chat Area -->
                    <div class="card" style="display: flex; flex-direction: column;">
                        <div id="chat-header" style="padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <h3 style="color: var(--text);">Select a conversation</h3>
                        </div>
                        
                        <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem 0;">
                            <!-- Messages will be displayed here -->
                        </div>
                        
                        <div id="chat-input-area" style="padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); display: none;">
                            <div style="display: flex; gap: 1rem;">
                                <input type="text" id="message-input" placeholder="Type a message..." 
                                       style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.05); 
                                              border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text);"
                                       onkeypress="if(event.key==='Enter') sendMessage()">
                                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Collaborate Page -->
        <section id="collaborate" class="page-section" role="main" aria-label="Collaboration section">
            <div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap;">
                    <h1 style="color: var(--text);">üéì Study Rooms & Collaboration</h1>
                    <button class="btn btn-primary" onclick="showCreateRoomModal()">
                        ‚ûï Create Room
                    </button>
                </div>
                
                <!-- Room Filters -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <input type="text" id="room-search" placeholder="üîç Search rooms..." 
                               style="flex: 1; min-width: 200px; padding: 0.75rem; background: rgba(255,255,255,0.05); 
                                      border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text);"
                               onkeyup="window.searchRooms(this.value)">
                        
                        <select id="room-filter" onchange="filterRooms()" 
                                style="padding: 0.75rem; background: #1e293b; 
                                       border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text);">
                            <option value="all" style="background: #1e293b;">All Rooms</option>
                            <option value="study" style="background: #1e293b;">üìö Study</option>
                            <option value="project" style="background: #1e293b;">üíª Project</option>
                            <option value="social" style="background: #1e293b;">üéâ Social</option>
                            <option value="help" style="background: #1e293b;">üÜò Help</option>
                        </select>
                        
                        <select id="room-status" onchange="filterRooms()" 
                                style="padding: 0.75rem; background: #1e293b; 
                                       border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text);">
                            <option value="all" style="background: #1e293b;">All Status</option>
                            <option value="active" style="background: #1e293b;">üü¢ Active</option>
                            <option value="waiting" style="background: #1e293b;">‚è≥ Waiting</option>
                            <option value="full" style="background: #1e293b;">üî¥ Full</option>
                        </select>
                    </div>
                </div>
                
                <!-- My Rooms Section -->
                <div style="margin-bottom: 2rem;">
                    <h2 style="color: var(--text); margin-bottom: 1rem;">üë§ My Rooms</h2>
                    <div id="my-rooms" class="grid grid-cols-3">
                        <!-- User's created rooms will be displayed here -->
                    </div>
                </div>
                
                <!-- Public Rooms Section -->
                <div>
                    <h2 style="color: var(--text); margin-bottom: 1rem;">üåê Public Rooms</h2>
                    <div id="public-rooms" class="grid grid-cols-3">
                        <!-- Public rooms will be loaded here -->
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <script>
        // ============================================
        // ENHANCED GLOBAL STATE WITH PERSISTENCE
        // ============================================
        const APP_STATE = {
            currentUser: null,
            currentPage: 'home',
            theme: localStorage.getItem('theme') || 'dark',
            projects: [],
            discussions: [],
            notifications: [],
            starredProjects: new Set(),
            followingUsers: new Set(),
            techFilters: new Set(),
            userProfiles: new Map(),
            activityFeed: [],
            friends: new Map(),
            friendRequests: [],
            messages: [],
            groupChats: [],
            onlineUsers: new Set(),
            blockedUsers: new Set(),
            rooms: [],
            activeRoom: null,
            roomMessages: new Map(),
            peerConnections: new Map(),
            localStream: null,
            screenStream: null
        };
        
        // Load saved data from localStorage
        function loadAppData() {
            try {
                const savedProjects = localStorage.getItem('aiHub_projects');
                if (savedProjects) APP_STATE.projects = JSON.parse(savedProjects);
                
                const savedUser = localStorage.getItem('aiHub_currentUser');
                if (savedUser) APP_STATE.currentUser = JSON.parse(savedUser);
                
                const savedStarred = localStorage.getItem('aiHub_starred');
                if (savedStarred) APP_STATE.starredProjects = new Set(JSON.parse(savedStarred));
                
                const savedFollowing = localStorage.getItem('aiHub_following');
                if (savedFollowing) APP_STATE.followingUsers = new Set(JSON.parse(savedFollowing));
                
                const savedDiscussions = localStorage.getItem('aiHub_discussions');
                if (savedDiscussions) APP_STATE.discussions = JSON.parse(savedDiscussions);
                
                const savedNotifications = localStorage.getItem('aiHub_notifications');
                if (savedNotifications) APP_STATE.notifications = JSON.parse(savedNotifications);
                
                const savedRooms = localStorage.getItem('aiHub_rooms');
                if (savedRooms) APP_STATE.rooms = JSON.parse(savedRooms);
                
                updateNotificationBadge();
            } catch (error) {
                console.error('Error loading app data:', error);
            }
        }
        
        // Save data to localStorage
        function saveAppData(key, value) {
            try {
                const prefix = 'aiHub_';
                if (value instanceof Set) {
                    localStorage.setItem(prefix + key, JSON.stringify(Array.from(value)));
                } else if (value instanceof Map) {
                    localStorage.setItem(prefix + key, JSON.stringify(Array.from(value.entries())));
                } else {
                    localStorage.setItem(prefix + key, JSON.stringify(value));
                }
            } catch (error) {
                console.error('Error saving app data:', error);
                showToast('Failed to save data', 'error');
            }
        }
        
        // ============================================
        // THEME MANAGEMENT
        // ============================================
        function initTheme() {
            document.documentElement.setAttribute('data-theme', APP_STATE.theme);
            updateThemeIcon();
        }
        
        function toggleTheme() {
            APP_STATE.theme = APP_STATE.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', APP_STATE.theme);
            localStorage.setItem('theme', APP_STATE.theme);
            updateThemeIcon();
            showToast(`Switched to ${APP_STATE.theme} mode`, 'info');
        }
        
        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            icon.textContent = APP_STATE.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
        
        // ============================================
        // NAVIGATION WITH PROGRESS BAR
        // ============================================
        function navigateTo(page) {
            // Show progress bar
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = '30%';
            
            // Hide all sections
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Update progress
            progressBar.style.width = '60%';
            
            // Show selected section
            const targetSection = document.getElementById(page);
            if (targetSection) {
                targetSection.classList.add('active');
                APP_STATE.currentPage = page;
            }
            
            // Update nav buttons
            document.querySelectorAll('.nav-links button').forEach(btn => {
                btn.classList.remove('active');
            });
            const navBtn = document.getElementById('nav-' + page);
            if (navBtn) navBtn.classList.add('active');
            
            // Complete progress
            progressBar.style.width = '100%';
            setTimeout(() => {
                progressBar.style.width = '0%';
            }, 300);
            
            // Close mobile menu if open
            closeMobileMenu();
            
            // Load page-specific content
            loadPageContent(page);
            
            // Track page view
            trackPageView(page);
        }
        
        function loadPageContent(page) {
            switch(page) {
                case 'projects':
                    loadProjects();
                    // Show all projects initially
                    setTimeout(() => {
                        window.searchProjects('');
                    }, 100);
                    break;
                case 'profile':
                    loadUserProfile();
                    break;
                case 'discussions':
                    loadDiscussions();
                    break;
                case 'friends':
                    loadFriendsPage();
                    break;
                case 'messages':
                    loadMessagesPage();
                    break;
                case 'collaborate':
                    renderRooms();
                    // Show all rooms initially
                    setTimeout(() => {
                        window.searchRooms('');
                    }, 100);
                    break;
            }
        }
        
        // ============================================
        // MOBILE MENU
        // ============================================
        function initMobileMenu() {
            const toggle = document.getElementById('mobile-menu-toggle');
            const navLinks = document.getElementById('nav-links');
            
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('active');
                navLinks.classList.toggle('active');
            });
        }
        
        function closeMobileMenu() {
            const toggle = document.getElementById('mobile-menu-toggle');
            const navLinks = document.getElementById('nav-links');
            toggle.classList.remove('active');
            navLinks.classList.remove('active');
        }
        
        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            }[type] || '‚ÑπÔ∏è';
            
            toast.innerHTML = `
                <span>${icon}</span>
                <span>${message}</span>
            `;
            
            toast.addEventListener('click', () => {
                toast.style.animation = 'slideOutRight 0.3s';
                setTimeout(() => toast.remove(), 300);
            });
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // ============================================
        // NOTIFICATIONS SYSTEM
        // ============================================
        function addNotification(type, message) {
            const notification = {
                id: Date.now(),
                type,
                message,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            APP_STATE.notifications.unshift(notification);
            saveAppData('notifications', APP_STATE.notifications);
            updateNotificationBadge();
            
            // Show real-time notification
            showToast(message, 'info');
        }
        
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-count');
            const unreadCount = APP_STATE.notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function showNotifications() {
            const modal = createModal('Notifications', `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${APP_STATE.notifications.length === 0 ? '<p>No notifications</p>' : ''}
                    ${APP_STATE.notifications.map(n => `
                        <div class="activity-item" style="${n.read ? 'opacity: 0.6;' : ''}">
                            <div class="activity-icon">${getNotificationIcon(n.type)}</div>
                            <div class="activity-content">
                                <div>${n.message}</div>
                                <div class="activity-time">${formatTime(n.timestamp)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="clearNotifications()">
                    Clear All
                </button>
            `);
            
            // Mark all as read
            APP_STATE.notifications.forEach(n => n.read = true);
            saveAppData('notifications', APP_STATE.notifications);
            updateNotificationBadge();
        }
        
        function getNotificationIcon(type) {
            const icons = {
                like: '‚ù§Ô∏è',
                comment: 'üí¨',
                follow: 'üë§',
                project: 'üìÅ',
                achievement: 'üèÜ'
            };
            return icons[type] || 'üì¢';
        }
        
        function clearNotifications() {
            APP_STATE.notifications = [];
            saveAppData('notifications', APP_STATE.notifications);
            updateNotificationBadge();
            closeModal();
            showToast('Notifications cleared', 'success');
        }
        
        // ============================================
        // PROJECTS FUNCTIONALITY
        // ============================================
        async function loadProjects() {
            const grid = document.getElementById('projects-grid');
            
            // Show loading skeleton
            const loading = document.getElementById('projects-loading');
            loading.style.display = 'block';
            grid.style.display = 'none';
            
            // Load projects from API
            APP_STATE.projects = await ApiService.getProjects();
            
            // If no projects from API, load sample projects
            if (APP_STATE.projects.length === 0) {
                loadSampleProjects();
            }
            
            // Simulate loading delay for better UX
            setTimeout(() => {
                loading.style.display = 'none';
                grid.style.display = 'grid';
                renderProjects();
            }, 500);
        }
        
        function loadSampleProjects() {
            APP_STATE.projects = [
                {
                    id: 'proj_1',
                    title: 'AI Image Generator',
                    category: 'ai-ml',
                    description: 'Generate images from text using DALL-E API',
                    tech: ['Python', 'TensorFlow', 'React'],
                    author: 'Alice Dev',
                    authorId: 'user_1',
                    created: new Date(Date.now() - 86400000 * 5).toISOString(),
                    likes: 42,
                    stars: 15,
                    comments: [],
                    version: '1.0.0'
                },
                {
                    id: 'proj_2',
                    title: 'Smart Task Manager',
                    category: 'web-dev',
                    description: 'AI-powered task management system',
                    tech: ['JavaScript', 'Node.js', 'MongoDB'],
                    author: 'Bob Builder',
                    authorId: 'user_2',
                    created: new Date(Date.now() - 86400000 * 2).toISOString(),
                    likes: 23,
                    stars: 8,
                    comments: [],
                    version: '2.1.0'
                }
            ];
            // Save the sample projects
            saveAppData('projects', APP_STATE.projects);
        }
        
        function renderProjects() {
            const grid = document.getElementById('projects-grid');
            if (!grid) return;
            
            // Use filterProjects instead which handles everything
            filterProjects();
        }
        
        function renderProjectsOriginal() {
            const grid = document.getElementById('projects-grid');
            const filteredProjects = filterProjectsList();
            
            if (filteredProjects.length === 0) {
                grid.innerHTML = '<div class="card" style="grid-column: 1 / -1; text-align: center;"><p>No projects found</p></div>';
                return;
            }
            
            grid.innerHTML = filteredProjects.map(project => `
                <div class="card project-card" data-id="${project.id}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <h3 style="color: var(--primary); flex: 1;">${project.title}</h3>
                        <button class="bookmark-btn ${APP_STATE.starredProjects.has(project.id) ? 'bookmarked' : ''}" 
                                onclick="toggleStar('${project.id}')" aria-label="Star project">
                            ${APP_STATE.starredProjects.has(project.id) ? '‚≠ê' : '‚òÜ'}
                        </button>
                    </div>
                    
                    <p style="margin-bottom: 1rem;">${project.description}</p>
                    
                    <div class="filter-tags" style="margin-bottom: 1rem;">
                        ${project.tech.map(t => `<span class="filter-tag">${t}</span>`).join('')}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; opacity: 0.8;">
                        <div style="display: flex; gap: 1rem;">
                            <span>‚ù§Ô∏è ${project.likes}</span>
                            <span>‚≠ê ${project.stars}</span>
                            <span>üí¨ ${project.comments.length}</span>
                        </div>
                        <span>v${project.version}</span>
                    </div>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.875rem;">By ${project.author}</span>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" 
                                    onclick="viewProject('${project.id}')">
                                View Details ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function filterProjectsList() {
            let filtered = [...APP_STATE.projects];
            
            // Search filter
            const searchTerm = document.getElementById('project-search')?.value?.toLowerCase();
            if (searchTerm && searchTerm.trim() !== '') {
                filtered = filtered.filter(p => 
                    p.title.toLowerCase().includes(searchTerm) ||
                    p.description.toLowerCase().includes(searchTerm) ||
                    (p.tech && p.tech.some(t => t.toLowerCase().includes(searchTerm))) ||
                    p.author.toLowerCase().includes(searchTerm)
                );
            }
            
            // Category filter
            const category = document.getElementById('category-filter')?.value;
            if (category && category !== '') {
                filtered = filtered.filter(p => p.category === category);
            }
            
            // Tech stack filter
            if (APP_STATE.techFilters.size > 0) {
                filtered = filtered.filter(p => 
                    p.tech && Array.from(APP_STATE.techFilters).some(tech => 
                        p.tech.includes(tech)
                    )
                );
            }
            
            return filtered;
        }
        
        function filterProjects() {
            const searchInput = document.getElementById('project-search');
            const categorySelect = document.getElementById('category-filter');
            const sortSelect = document.getElementById('sort-filter');
            const grid = document.getElementById('projects-grid');
            
            // If elements aren't found, try again after a short delay
            if (!searchInput || !categorySelect || !grid) {
                setTimeout(() => filterProjects(), 100);
                return;
            }
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const categoryFilter = categorySelect.value;
            
            // Filter projects
            let filtered = APP_STATE.projects.filter(project => {
                // Search filter
                let matchesSearch = true;
                if (searchTerm) {
                    matchesSearch = 
                        project.title.toLowerCase().includes(searchTerm) ||
                        project.description.toLowerCase().includes(searchTerm) ||
                        project.author.toLowerCase().includes(searchTerm) ||
                        (project.tech && project.tech.some(t => t.toLowerCase().includes(searchTerm)));
                }
                
                // Category filter
                let matchesCategory = true;
                if (categoryFilter && categoryFilter !== '') {
                    matchesCategory = project.category === categoryFilter;
                }
                
                return matchesSearch && matchesCategory;
            });
            
            // Apply tech filters if any
            if (APP_STATE.techFilters.size > 0) {
                filtered = filtered.filter(p => 
                    p.tech && Array.from(APP_STATE.techFilters).some(tech => 
                        p.tech.includes(tech)
                    )
                );
            }
            
            // Sort the filtered results
            const sortBy = sortSelect ? sortSelect.value : 'recent';
            switch(sortBy) {
                case 'popular':
                    filtered.sort((a, b) => ((b.likes || 0) + (b.stars || 0)) - ((a.likes || 0) + (a.stars || 0)));
                    break;
                case 'active':
                    filtered.sort((a, b) => (b.comments?.length || 0) - (a.comments?.length || 0));
                    break;
                case 'recent':
                default:
                    filtered.sort((a, b) => new Date(b.created) - new Date(a.created));
            }
            
            // Render filtered and sorted projects
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="card" style="grid-column: 1 / -1; text-align: center;">
                        <p>No projects found${searchTerm ? ` for "${searchTerm}"` : ''}</p>
                    </div>`;
                return;
            }
            
            // Render the projects
            grid.innerHTML = filtered.map(project => createProjectCard(project)).join('');
        }
        
        function createProjectCard(project) {
            return `
                <div class="card project-card" data-id="${project.id}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <h3 style="color: var(--primary); flex: 1;">${project.title}</h3>
                        <button class="bookmark-btn ${APP_STATE.starredProjects.has(project.id) ? 'bookmarked' : ''}" 
                                onclick="toggleStar('${project.id}')" aria-label="Star project">
                            ${APP_STATE.starredProjects.has(project.id) ? '‚≠ê' : '‚òÜ'}
                        </button>
                    </div>
                    
                    <p style="margin-bottom: 1rem;">${project.description}</p>
                    
                    ${project.tech && project.tech.length > 0 ? `
                        <div class="filter-tags" style="margin-bottom: 1rem;">
                            ${project.tech.map(t => `<span class="filter-tag" onclick="filterByTechTag('${t}')" style="cursor: pointer;" title="Click to filter by ${t}">${t}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; opacity: 0.8;">
                        <div style="display: flex; gap: 1rem;">
                            <span>‚ù§Ô∏è ${project.likes || 0}</span>
                            <span>‚≠ê ${project.stars || 0}</span>
                            <span>üí¨ ${project.comments?.length || 0}</span>
                        </div>
                        <span>v${project.version || '1.0.0'}</span>
                    </div>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.875rem;">By ${project.author}</span>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" 
                                    onclick="viewProject('${project.id}')">
                                View Details ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function sortProjects() {
            const sortBy = document.getElementById('sort-filter')?.value || 'recent';
            console.log('Sorting by:', sortBy); // Debug
            
            // Get filtered projects first
            let filtered = filterProjectsList();
            
            switch(sortBy) {
                case 'popular':
                    filtered.sort((a, b) => ((b.likes || 0) + (b.stars || 0)) - ((a.likes || 0) + (a.stars || 0)));
                    break;
                case 'active':
                    filtered.sort((a, b) => (b.comments?.length || 0) - (a.comments?.length || 0));
                    break;
                case 'recent':
                default:
                    filtered.sort((a, b) => new Date(b.created) - new Date(a.created));
            }
            
            // Render the sorted and filtered projects
            const grid = document.getElementById('projects-grid');
            if (!grid) return;
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="card" style="grid-column: 1 / -1; text-align: center;"><p>No projects found matching your filters</p></div>';
                return;
            }
            
            grid.innerHTML = filtered.map(project => `
                <div class="card project-card" data-id="${project.id}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <h3 style="color: var(--primary); flex: 1;">${project.title}</h3>
                        <button class="bookmark-btn ${APP_STATE.starredProjects.has(project.id) ? 'bookmarked' : ''}" 
                                onclick="toggleStar('${project.id}')" aria-label="Star project">
                            ${APP_STATE.starredProjects.has(project.id) ? '‚≠ê' : '‚òÜ'}
                        </button>
                    </div>
                    
                    <p style="margin-bottom: 1rem;">${project.description}</p>
                    
                    <div class="filter-tags" style="margin-bottom: 1rem;">
                        ${project.tech ? project.tech.map(t => `<span class="filter-tag">${t}</span>`).join('') : ''}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; opacity: 0.8;">
                        <div style="display: flex; gap: 1rem;">
                            <span>‚ù§Ô∏è ${project.likes || 0}</span>
                            <span>‚≠ê ${project.stars || 0}</span>
                            <span>üí¨ ${project.comments?.length || 0}</span>
                        </div>
                        <span>v${project.version || '1.0.0'}</span>
                    </div>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.875rem;">By ${project.author}</span>
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" 
                                    onclick="viewProject('${project.id}')">
                                View Details ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleTechFilter(tech) {
            if (APP_STATE.techFilters.has(tech)) {
                APP_STATE.techFilters.delete(tech);
            } else {
                APP_STATE.techFilters.add(tech);
            }
            
            // Update UI
            document.querySelectorAll('.filter-tag').forEach(tag => {
                if (tag.textContent === tech) {
                    tag.classList.toggle('active');
                }
            });
            
            filterProjects();
        }
        
        function toggleStar(projectId) {
            if (APP_STATE.starredProjects.has(projectId)) {
                APP_STATE.starredProjects.delete(projectId);
                const project = APP_STATE.projects.find(p => p.id === projectId);
                if (project) project.stars--;
            } else {
                APP_STATE.starredProjects.add(projectId);
                const project = APP_STATE.projects.find(p => p.id === projectId);
                if (project) project.stars++;
            }
            
            saveAppData('starred', APP_STATE.starredProjects);
            saveAppData('projects', APP_STATE.projects);
            renderProjects();
            
            showToast(APP_STATE.starredProjects.has(projectId) ? 'Project starred!' : 'Star removed', 'success');
        }
        
        function showCreateProjectModal() {
            if (!APP_STATE.currentUser) {
                showAuthModal();
                return;
            }
            
            const modal = createModal('Create New Project', `
                <form id="create-project-form" onsubmit="createProject(event)" style="font-size: 0.875rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Title *</label>
                            <input type="text" id="project-title" required maxlength="100" 
                                   placeholder="Project name"
                                   style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                          border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                          color: var(--text); font-size: 0.8rem;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Category *</label>
                            <select id="project-category" required
                                    style="width: 100%; padding: 0.4rem; background: #1e293b;
                                           border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                           color: var(--text); font-size: 0.8rem;">
                                <option value="ai-ml">ü§ñ AI/ML</option>
                                <option value="web-dev">üåê Web Dev</option>
                                <option value="mobile">üì± Mobile</option>
                                <option value="data-science">üìä Data</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Description *</label>
                        <textarea id="project-description" required rows="2" maxlength="500"
                                  placeholder="Brief description"
                                  style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                         border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                         color: var(--text); font-size: 0.8rem; resize: none;"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Technologies</label>
                            <input type="text" id="project-tech" 
                                   placeholder="Python, React"
                                   style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                          border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                          color: var(--text); font-size: 0.8rem;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Files</label>
                            <input type="file" id="project-files" multiple style="display: none;" 
                                   onchange="handleFileSelect(event, 'project')">
                            <button type="button" class="btn btn-secondary" 
                                    onclick="document.getElementById('project-files').click()"
                                    style="width: 100%; padding: 0.4rem; font-size: 0.8rem;">
                                üìé Attach
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Documentation</label>
                        <textarea id="project-docs" rows="2" 
                                  placeholder="Optional notes"
                                  style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                         border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                         color: var(--text); font-size: 0.8rem; resize: none;"></textarea>
                    </div>
                    
                    <div id="project-files-preview" style="max-height: 60px; overflow-y: auto; margin-bottom: 0.75rem;"></div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">üöÄ Create</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" 
                                style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">Cancel</button>
                    </div>
                </form>
            `);
            
            // Adjust modal size
            modal.querySelector('.modal-content').style.maxWidth = '450px';
            modal.querySelector('.modal-content').style.maxHeight = 'fit-content';
        }
        
        async function createProject(event) {
            event.preventDefault();
            
            const title = document.getElementById('project-title').value.trim();
            const category = document.getElementById('project-category').value;
            const description = document.getElementById('project-description').value.trim();
            const tech = document.getElementById('project-tech').value.split(',').map(t => t.trim()).filter(t => t);
            const docs = document.getElementById('project-docs').innerHTML;
            
            if (!validateProjectInput(title, description)) {
                return;
            }
            
            const projectData = {
                title: sanitizeInput(title),
                category,
                description: sanitizeInput(description),
                tech,
                documentation: docs,
                files: uploadedFiles.project || [],
                author: APP_STATE.currentUser.username,
                authorId: APP_STATE.currentUser.id
            };
            
            // Try to create via API first
            let newProject = await ApiService.createProject(projectData);
            
            // If API fails, create locally
            if (!newProject) {
                newProject = {
                    id: 'proj_' + Date.now(),
                    ...projectData,
                    created: new Date().toISOString(),
                    likes: 0,
                    stars: 0,
                    comments: [],
                    version: '1.0.0'
                };
                
                APP_STATE.projects.unshift(newProject);
                saveAppData('projects', APP_STATE.projects);
            } else {
                // Update local state with API response
                APP_STATE.projects.unshift(newProject);
            }
            
            // Clear uploaded files
            uploadedFiles.project = [];
            
            // Add to activity feed
            addActivityItem('project', `${APP_STATE.currentUser.username} created "${title}"`);
            
            // Add notification
            addNotification('project', `Your project "${title}" was created successfully!`);
            
            closeModal();
            renderProjects();
            showToast('Project created successfully!', 'success');
        }
        
        function validateProjectInput(title, description) {
            const errors = [];
            
            if (title.length < 3) errors.push('Title must be at least 3 characters');
            if (title.length > 100) errors.push('Title must be less than 100 characters');
            if (description.length < 10) errors.push('Description must be at least 10 characters');
            if (description.length > 500) errors.push('Description must be less than 500 characters');
            
            // Check for malicious content
            const dangerousPatterns = /<script|javascript:|on\w+=/gi;
            if (dangerousPatterns.test(title) || dangerousPatterns.test(description)) {
                errors.push('Invalid content detected');
            }
            
            if (errors.length > 0) {
                errors.forEach(error => showToast(error, 'error'));
                return false;
            }
            
            return true;
        }
        
        function sanitizeInput(input) {
            // Basic XSS prevention
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }
        
        function viewProject(projectId) {
            const project = APP_STATE.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const modal = createModal(project.title, `
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <span style="color: var(--text); opacity: 0.8;">
                        By ${project.author} ‚Ä¢ ${formatTime(project.created)}
                    </span>
                    <span style="color: var(--primary);">v${project.version}</span>
                </div>
                
                <p style="margin-bottom: 1.5rem;">${project.description}</p>
                
                ${project.documentation ? `
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        ${project.documentation}
                    </div>
                ` : ''}
                
                <div class="filter-tags" style="margin-bottom: 1.5rem;">
                    ${project.tech.map(t => `<span class="filter-tag active">${t}</span>`).join('')}
                </div>
                
                ${project.files && project.files.length > 0 ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--primary); margin-bottom: 0.5rem;">üìé Attached Files (${project.files.length})</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            ${project.files.map(file => `
                                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; 
                                            background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                                    ${file.isImage ? `
                                        <div style="width: 50px; height: 50px; background: url('${file.dataUrl}') center/cover; 
                                                    border-radius: 0.25rem;"></div>
                                    ` : `
                                        <div style="font-size: 1.5rem;">${getFileIcon(file.type)}</div>
                                    `}
                                    <div style="flex: 1;">
                                        <div style="color: var(--text);">${file.name}</div>
                                        <div style="color: var(--text); opacity: 0.6; font-size: 0.875rem;">
                                            ${formatFileSize(file.size)}
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary" style="padding: 0.5rem;" 
                                            onclick="downloadProjectFile('${project.id}', '${file.name}')">
                                        ‚¨áÔ∏è Download
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 1rem; padding: 1rem 0; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button class="btn btn-primary" onclick="likeProject('${project.id}')">
                        ‚ù§Ô∏è Like (${project.likes})
                    </button>
                    <button class="btn btn-secondary" onclick="showProjectComments('${project.id}')">
                        üí¨ Comments (${project.comments.length})
                    </button>
                    <button class="btn btn-secondary" onclick="shareProject('${project.id}')">
                        üì§ Share
                    </button>
                    ${project.authorId === APP_STATE.currentUser?.id ? `
                        <button class="btn btn-secondary" onclick="editProject('${project.id}')">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn" style="background: var(--danger); color: white;" onclick="deleteProject('${project.id}')">
                            üóëÔ∏è Delete
                        </button>
                    ` : ''}
                </div>
            `);
        }
        
        function likeProject(projectId) {
            const project = APP_STATE.projects.find(p => p.id === projectId);
            if (project) {
                project.likes++;
                saveAppData('projects', APP_STATE.projects);
                renderProjects();
                showToast('Project liked!', 'success');
                
                // Add to activity
                addActivityItem('like', `You liked "${project.title}"`);
            }
        }
        
        function shareProject(projectId) {
            const project = APP_STATE.projects.find(p => p.id === projectId);
            if (project) {
                const url = window.location.href + '#project-' + projectId;
                navigator.clipboard.writeText(url);
                showToast('Project link copied to clipboard!', 'success');
            }
        }
        
        // ============================================
        // USER PROFILE FUNCTIONALITY
        // ============================================
        function loadUserProfile() {
            if (!APP_STATE.currentUser) {
                showAuthModal();
                return;
            }
            
            // Update profile display
            document.getElementById('profile-name').textContent = APP_STATE.currentUser.username;
            document.getElementById('profile-bio').textContent = APP_STATE.currentUser.bio || 'AI enthusiast and developer';
            document.getElementById('profile-avatar').textContent = APP_STATE.currentUser.avatar || 'üë§';
            
            // Update stats
            const userProjects = APP_STATE.projects.filter(p => p.authorId === APP_STATE.currentUser.id);
            document.getElementById('project-count').textContent = userProjects.length;
            document.getElementById('follower-count').textContent = APP_STATE.currentUser.followers || 0;
            document.getElementById('following-count').textContent = APP_STATE.followingUsers.size;
            
            // Load default tab
            showProfileTab('projects');
        }
        
        function showProfileTab(tab) {
            const content = document.getElementById('profile-content');
            
            switch(tab) {
                case 'projects':
                    const userProjects = APP_STATE.projects.filter(p => p.authorId === APP_STATE.currentUser?.id);
                    content.innerHTML = `
                        <div class="grid grid-cols-2">
                            ${userProjects.length === 0 ? '<p>No projects yet</p>' : ''}
                            ${userProjects.map(p => createProjectCard(p)).join('')}
                        </div>
                    `;
                    break;
                    
                case 'starred':
                    const starredProjects = APP_STATE.projects.filter(p => APP_STATE.starredProjects.has(p.id));
                    content.innerHTML = `
                        <div class="grid grid-cols-2">
                            ${starredProjects.length === 0 ? '<p>No starred projects</p>' : ''}
                            ${starredProjects.map(p => createProjectCard(p)).join('')}
                        </div>
                    `;
                    break;
                    
                case 'activity':
                    content.innerHTML = `
                        <div class="card">
                            ${APP_STATE.activityFeed.slice(0, 10).map(a => `
                                <div class="activity-item">
                                    <div class="activity-icon">${getNotificationIcon(a.type)}</div>
                                    <div class="activity-content">
                                        <div>${a.message}</div>
                                        <div class="activity-time">${formatTime(a.timestamp)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'achievements':
                    content.innerHTML = `
                        <div class="grid grid-cols-3">
                            ${createAchievementCard('üèÜ', 'First Project', 'Created your first project', true)}
                            ${createAchievementCard('‚≠ê', 'Star Collector', 'Received 10 stars', false)}
                            ${createAchievementCard('üí¨', 'Communicator', 'Posted 50 comments', false)}
                            ${createAchievementCard('ü§ù', 'Collaborator', 'Joined 5 projects', false)}
                        </div>
                    `;
                    break;
            }
        }
        
        function createProjectCard(project) {
            return `
                <div class="card">
                    <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${project.title}</h4>
                    <p style="font-size: 0.875rem; margin-bottom: 1rem;">${project.description}</p>
                    <div style="display: flex; gap: 1rem; font-size: 0.875rem;">
                        <span>‚ù§Ô∏è ${project.likes}</span>
                        <span>‚≠ê ${project.stars}</span>
                        <span>üí¨ ${project.comments.length}</span>
                    </div>
                </div>
            `;
        }
        
        function createAchievementCard(icon, title, description, earned) {
            return `
                <div class="card" style="${!earned ? 'opacity: 0.5; filter: grayscale(1);' : ''}">
                    <div style="font-size: 2rem; text-align: center; margin-bottom: 0.5rem;">${icon}</div>
                    <h4 style="color: var(--primary); text-align: center; margin-bottom: 0.5rem;">${title}</h4>
                    <p style="font-size: 0.875rem; text-align: center;">${description}</p>
                </div>
            `;
        }
        
        function editProfile() {
            const modal = createModal('Edit Profile', `
                <form onsubmit="updateProfile(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="edit-username" value="${APP_STATE.currentUser.username}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Bio</label>
                        <textarea id="edit-bio" rows="3">${APP_STATE.currentUser.bio || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Avatar Emoji</label>
                        <input type="text" id="edit-avatar" value="${APP_STATE.currentUser.avatar || 'üë§'}" maxlength="2">
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }
        
        function updateProfile(event) {
            event.preventDefault();
            
            APP_STATE.currentUser.username = document.getElementById('edit-username').value;
            APP_STATE.currentUser.bio = document.getElementById('edit-bio').value;
            APP_STATE.currentUser.avatar = document.getElementById('edit-avatar').value;
            
            saveAppData('currentUser', APP_STATE.currentUser);
            loadUserProfile();
            closeModal();
            showToast('Profile updated successfully!', 'success');
        }
        
        // ============================================
        // ACTIVITY FEED
        // ============================================
        function addActivityItem(type, message) {
            const activity = {
                type,
                message,
                timestamp: new Date().toISOString()
            };
            
            APP_STATE.activityFeed.unshift(activity);
            if (APP_STATE.activityFeed.length > 50) {
                APP_STATE.activityFeed = APP_STATE.activityFeed.slice(0, 50);
            }
            
            saveAppData('activityFeed', APP_STATE.activityFeed);
            updateActivityFeed();
        }
        
        function updateActivityFeed() {
            const feed = document.getElementById('activity-feed');
            if (feed && APP_STATE.currentPage === 'home') {
                feed.innerHTML = APP_STATE.activityFeed.slice(0, 5).map(a => `
                    <div class="activity-item">
                        <div class="activity-icon">${getNotificationIcon(a.type)}</div>
                        <div class="activity-content">
                            <div>${a.message}</div>
                            <div class="activity-time">${formatTime(a.timestamp)}</div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // ============================================
        // AUTHENTICATION
        // ============================================
        function showAuthModal() {
            const modal = createModal('Sign In', `
                <form onsubmit="handleAuth(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="auth-username" required minlength="3" maxlength="20">
                    </div>
                    
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="auth-email" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="auth-password" required minlength="6">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Sign In / Register
                    </button>
                </form>
            `);
        }
        
        function handleAuth(event) {
            event.preventDefault();
            
            const username = document.getElementById('auth-username').value;
            const email = document.getElementById('auth-email').value;
            
            APP_STATE.currentUser = {
                id: 'user_' + Date.now(),
                username,
                email,
                avatar: 'üë§',
                bio: '',
                followers: 0,
                created: new Date().toISOString()
            };
            
            saveAppData('currentUser', APP_STATE.currentUser);
            updateAuthButton();
            closeModal();
            showToast(`Welcome, ${username}!`, 'success');
            
            // Add to activity
            addActivityItem('follow', `${username} joined the platform`);
        }
        
        function updateAuthButton() {
            const btn = document.getElementById('auth-btn');
            if (APP_STATE.currentUser) {
                btn.textContent = APP_STATE.currentUser.username;
                btn.onclick = showUserMenu;
            } else {
                btn.textContent = 'Sign In';
                btn.onclick = showAuthModal;
            }
        }
        
        function showUserMenu() {
            const modal = createModal('User Menu', `
                <div class="user-profile-card">
                    <div class="user-avatar">${APP_STATE.currentUser.avatar}</div>
                    <h3>${APP_STATE.currentUser.username}</h3>
                    <p style="color: var(--text); opacity: 0.8;">${APP_STATE.currentUser.email}</p>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="navigateTo('profile'); closeModal();">
                        üë§ My Profile
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        üì• Export Data
                    </button>
                    <button class="btn btn-secondary" onclick="importData()">
                        üì§ Import Data
                    </button>
                    <button class="btn" style="background: var(--danger); color: white;" onclick="logout()">
                        üö™ Sign Out
                    </button>
                </div>
            `);
        }
        
        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                APP_STATE.currentUser = null;
                saveAppData('currentUser', null);
                updateAuthButton();
                closeModal();
                navigateTo('home');
                showToast('You have been signed out', 'info');
            }
        }
        
        // ============================================
        // RICH TEXT EDITOR FUNCTIONS
        // ============================================
        function formatText(command) {
            document.execCommand(command, false, null);
        }
        
        function insertLink() {
            const url = prompt('Enter URL:');
            if (url) {
                document.execCommand('createLink', false, url);
            }
        }
        
        function insertCode() {
            const code = prompt('Enter code:');
            if (code) {
                document.execCommand('insertHTML', false, `<code>${code}</code>`);
            }
        }
        
        // ============================================
        // DATA EXPORT/IMPORT
        // ============================================
        function exportData() {
            const data = {
                projects: APP_STATE.projects,
                user: APP_STATE.currentUser,
                starred: Array.from(APP_STATE.starredProjects),
                activity: APP_STATE.activityFeed,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-hub-backup-${Date.now()}.json`;
            a.click();
            
            showToast('Data exported successfully!', 'success');
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function createModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'active-modal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="closeModal()" aria-label="Close modal" title="Close">√ó</button>
                    <h2 style="color: var(--primary); margin-bottom: 1.5rem;">${title}</h2>
                    ${content}
                </div>
            `;
            
            document.body.appendChild(modal);
            return modal;
        }
        
        function closeModal() {
            const modal = document.getElementById('active-modal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s';
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)} days ago`;
            
            return date.toLocaleDateString();
        }
        
        // ============================================
        // DISCUSSIONS FUNCTIONALITY
        // ============================================
        function loadDiscussions() {
            const list = document.getElementById('discussions-list');
            
            if (APP_STATE.discussions.length === 0) {
                // Load sample discussions
                APP_STATE.discussions = [
                    {
                        id: 'disc_1',
                        title: 'Best practices for training neural networks',
                        content: 'What are your tips for getting better results when training deep learning models?',
                        author: 'Alice Dev',
                        authorId: 'sample_user_1',
                        created: new Date(Date.now() - 86400000).toISOString(),
                        replies: 5,
                        category: 'question',
                        tags: ['neural-networks', 'deep-learning']
                    },
                    {
                        id: 'disc_2',
                        title: 'New to AI - Where to start?',
                        content: 'I\'m completely new to AI and machine learning. What resources would you recommend?',
                        author: 'Bob Builder',
                        authorId: 'sample_user_2',
                        created: new Date(Date.now() - 172800000).toISOString(),
                        replies: 12,
                        category: 'help',
                        tags: ['beginner', 'resources']
                    },
                    // Add a test discussion that any logged-in user can delete for testing
                    {
                        id: 'disc_test',
                        title: 'Test Discussion - You Can Delete This',
                        content: 'This is a test discussion to verify the delete functionality works. Feel free to delete it!',
                        author: APP_STATE.currentUser ? APP_STATE.currentUser.username : 'Test User',
                        authorId: APP_STATE.currentUser ? APP_STATE.currentUser.id : 'test_user',
                        created: new Date().toISOString(),
                        replies: 0,
                        category: 'general',
                        tags: ['test', 'delete-me']
                    }
                ];
                saveAppData('discussions', APP_STATE.discussions);
            }
            
            renderDiscussions();
        }
        
        function renderDiscussions() {
            const list = document.getElementById('discussions-list');
            
            if (APP_STATE.discussions.length === 0) {
                list.innerHTML = '<div class="card"><p>No discussions yet. Start the first one!</p></div>';
                return;
            }
            
            list.innerHTML = APP_STATE.discussions.map(discussion => {
                const isOwner = APP_STATE.currentUser && 
                    (discussion.authorId === APP_STATE.currentUser.id || discussion.author === APP_STATE.currentUser.username);
                
                
                return `
                    <div class="card" style="margin-bottom: 1rem; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1; cursor: pointer;" onclick="viewDiscussion('${discussion.id}')">
                                <h3 style="color: var(--primary); margin-bottom: 0.5rem;">${discussion.title}</h3>
                                <p style="margin-bottom: 1rem;">${discussion.content}</p>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    ${discussion.tags.map(tag => `
                                        <span style="padding: 0.25rem 0.5rem; background: rgba(124,58,237,0.2); 
                                               color: var(--primary); border-radius: 0.25rem; font-size: 0.75rem;">
                                            #${tag}
                                        </span>
                                    `).join('')}
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; 
                                            font-size: 0.875rem; color: var(--text); opacity: 0.8;">
                                    <span>By ${discussion.author} ‚Ä¢ ${formatTime(discussion.created)}</span>
                                    <span>üí¨ ${discussion.replies} replies</span>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                                <span style="padding: 0.25rem 0.75rem; background: rgba(59,130,246,0.2); 
                                       color: var(--secondary); border-radius: 1rem; font-size: 0.75rem;">
                                    ${discussion.category}
                                </span>
                                ${isOwner ? `
                                    <button onclick="event.stopPropagation(); deleteDiscussion('${discussion.id}')" 
                                            style="background: rgba(239,68,68,0.2); color: #ef4444; border: none; 
                                                   border-radius: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; 
                                                   cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='rgba(239,68,68,0.3)'"
                                            onmouseout="this.style.background='rgba(239,68,68,0.2)'">
                                        üóëÔ∏è Delete
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showNewDiscussionModal() {
            if (!APP_STATE.currentUser) {
                showAuthModal();
                return;
            }
            
            const modal = createModal('Start New Discussion', `
                <form onsubmit="createDiscussion(event)" style="font-size: 0.875rem;">
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Title *</label>
                        <input type="text" id="discussion-title" required maxlength="200" 
                               placeholder="Your question or topic"
                               style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                      border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                      color: var(--text); font-size: 0.8rem;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Category *</label>
                            <select id="discussion-category" required
                                    style="width: 100%; padding: 0.4rem; background: #1e293b;
                                           border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                           color: var(--text); font-size: 0.8rem;">
                                <option value="general">üí¨ General</option>
                                <option value="question">‚ùì Question</option>
                                <option value="help">üÜò Help</option>
                                <option value="tutorial">üìñ Tutorial</option>
                                <option value="showcase">üåü Showcase</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Tags</label>
                            <input type="text" id="discussion-tags" 
                                   placeholder="python, ML"
                                   style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                          border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                          color: var(--text); font-size: 0.8rem;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Content *</label>
                        <textarea id="discussion-content" required rows="3" maxlength="2000"
                                  placeholder="Describe in detail..."
                                  style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                         border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                         color: var(--text); font-size: 0.8rem; resize: none;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Attach Files</label>
                        <input type="file" id="discussion-files" multiple style="display: none;" 
                               onchange="handleFileSelect(event, 'discussion')">
                        <button type="button" class="btn btn-secondary" 
                                onclick="document.getElementById('discussion-files').click()"
                                style="width: 100%; padding: 0.4rem; font-size: 0.8rem;">
                            üìé Attach Files
                        </button>
                        <div id="discussion-files-preview" style="max-height: 60px; overflow-y: auto; margin-top: 0.5rem;"></div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">üìù Post</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" 
                                style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">Cancel</button>
                    </div>
                </form>
            `);
            
            // Adjust modal size
            modal.querySelector('.modal-content').style.maxWidth = '450px';
            modal.querySelector('.modal-content').style.maxHeight = 'fit-content';
        }
        
        async function createDiscussion(event) {
            event.preventDefault();
            
            const title = document.getElementById('discussion-title').value.trim();
            const category = document.getElementById('discussion-category').value;
            const content = document.getElementById('discussion-content').value.trim();
            const tags = document.getElementById('discussion-tags').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);
            
            if (!title || !content) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            const discussionData = {
                title: sanitizeInput(title),
                content: sanitizeInput(content),
                category,
                tags,
                files: uploadedFiles.discussion || [],
                author: APP_STATE.currentUser.username,
                authorId: APP_STATE.currentUser.id
            };
            
            // Try to create via API first
            let newDiscussion = await ApiService.createDiscussion(discussionData);
            
            // If API fails, create locally
            if (!newDiscussion) {
                newDiscussion = {
                    id: 'disc_' + Date.now(),
                    ...discussionData,
                    created: new Date().toISOString(),
                    replies: 0,
                    repliesData: []
                };
                
                APP_STATE.discussions.unshift(newDiscussion);
                saveAppData('discussions', APP_STATE.discussions);
            } else {
                // Update local state with API response
                APP_STATE.discussions.unshift(newDiscussion);
            }
            
            // Clear uploaded files
            uploadedFiles.discussion = [];
            
            // Add to activity feed
            addActivityItem('comment', `${APP_STATE.currentUser.username} started a discussion: "${title}"`);
            
            // Add notification
            addNotification('comment', `Your discussion "${title}" was posted!`);
            
            closeModal();
            renderDiscussions();
            showToast('Discussion posted successfully!', 'success');
        }
        
        async function deleteDiscussion(discussionId) {
            if (!APP_STATE.currentUser) {
                showToast('You must be logged in to delete discussions', 'error');
                return;
            }
            
            const discussion = APP_STATE.discussions.find(d => d.id === discussionId);
            if (!discussion) {
                showToast('Discussion not found', 'error');
                return;
            }
            
            // Check if user owns this discussion
            if (discussion.authorId !== APP_STATE.currentUser.id && discussion.author !== APP_STATE.currentUser.username) {
                showToast('You can only delete your own discussions', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this discussion? This action cannot be undone.')) {
                return;
            }
            
            // Try API delete first
            const deleted = await ApiService.deleteDiscussion(discussionId, APP_STATE.currentUser.id);
            
            if (deleted || ApiService.request === null) {
                // Remove from local state regardless of API success (for offline functionality)
                APP_STATE.discussions = APP_STATE.discussions.filter(d => d.id !== discussionId);
                saveAppData('discussions', APP_STATE.discussions);
                
                // Add to activity feed
                addActivityItem('delete', `${APP_STATE.currentUser.username} deleted a discussion: "${discussion.title}"`);
                
                renderDiscussions();
                showToast('Discussion deleted successfully!', 'success');
            } else {
                showToast('Failed to delete discussion. Please try again.', 'error');
            }
        }
        
        function viewDiscussion(discussionId) {
            const discussion = APP_STATE.discussions.find(d => d.id === discussionId);
            if (!discussion) return;
            
            const modal = createModal(discussion.title, `
                <div style="margin-bottom: 1rem;">
                    <span style="padding: 0.25rem 0.75rem; background: rgba(59,130,246,0.2); 
                           color: var(--secondary); border-radius: 1rem; font-size: 0.875rem;">
                        ${discussion.category}
                    </span>
                    <span style="margin-left: 1rem; color: var(--text); opacity: 0.8; font-size: 0.875rem;">
                        By ${discussion.author} ‚Ä¢ ${formatTime(discussion.created)}
                    </span>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <p style="margin-bottom: 1rem;">${discussion.content}</p>
                    <div style="display: flex; gap: 0.5rem;">
                        ${discussion.tags.map(tag => `
                            <span style="padding: 0.25rem 0.5rem; background: rgba(124,58,237,0.2); 
                                   color: var(--primary); border-radius: 0.25rem; font-size: 0.75rem;">
                                #${tag}
                            </span>
                        `).join('')}
                    </div>
                    
                    ${discussion.files && discussion.files.length > 0 ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                            <h5 style="color: var(--primary); margin-bottom: 0.5rem;">üìé Attachments</h5>
                            ${discussion.files.map(file => `
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    ${file.isImage ? `
                                        <img src="${file.dataUrl}" style="width: 100px; height: 75px; object-fit: cover; 
                                                border-radius: 0.25rem; cursor: pointer;" 
                                             onclick="viewFullImage('${file.dataUrl}', '${file.name}')">
                                    ` : `
                                        <span style="font-size: 1.25rem;">${getFileIcon(file.type)}</span>
                                    `}
                                    <span style="flex: 1; color: var(--text);">${file.name}</span>
                                    <span style="color: var(--text); opacity: 0.6; font-size: 0.875rem;">
                                        ${formatFileSize(file.size)}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">üí¨ Replies (${discussion.replies})</h4>
                    
                    ${APP_STATE.currentUser ? `
                        <div style="margin-bottom: 1rem;">
                            <textarea id="reply-content-${discussion.id}" rows="3" 
                                      style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); 
                                             border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; 
                                             color: var(--text);"
                                      placeholder="Write your reply..."></textarea>
                            <button class="btn btn-primary" style="margin-top: 0.5rem;" 
                                    onclick="addReply('${discussion.id}')">
                                Post Reply
                            </button>
                        </div>
                    ` : '<p style="color: var(--text); opacity: 0.8;">Sign in to reply</p>'}
                    
                    <div id="replies-list-${discussion.id}">
                        ${discussion.repliesData && discussion.repliesData.length > 0 ? 
                            discussion.repliesData.map(reply => `
                                <div style="background: rgba(0,0,0,0.2); padding: 1rem; 
                                            border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <strong style="color: var(--primary);">${reply.author}</strong>
                                        <span style="font-size: 0.875rem; opacity: 0.8;">
                                            ${formatTime(reply.created)}
                                        </span>
                                    </div>
                                    <p>${reply.content}</p>
                                </div>
                            `).join('') : 
                            '<p style="color: var(--text); opacity: 0.8;">No replies yet. Be the first!</p>'
                        }
                    </div>
                </div>
            `);
        }
        
        function addReply(discussionId) {
            const content = document.getElementById(`reply-content-${discussionId}`).value.trim();
            
            if (!content) {
                showToast('Please enter a reply', 'error');
                return;
            }
            
            const discussion = APP_STATE.discussions.find(d => d.id === discussionId);
            if (!discussion) return;
            
            if (!discussion.repliesData) {
                discussion.repliesData = [];
            }
            
            const reply = {
                id: 'reply_' + Date.now(),
                content: sanitizeInput(content),
                author: APP_STATE.currentUser.username,
                authorId: APP_STATE.currentUser.id,
                created: new Date().toISOString()
            };
            
            discussion.repliesData.push(reply);
            discussion.replies++;
            
            saveAppData('discussions', APP_STATE.discussions);
            
            // Update the replies list in the modal
            const repliesList = document.getElementById(`replies-list-${discussionId}`);
            if (repliesList) {
                repliesList.innerHTML = discussion.repliesData.map(r => `
                    <div style="background: rgba(0,0,0,0.2); padding: 1rem; 
                                border-radius: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong style="color: var(--primary);">${r.author}</strong>
                            <span style="font-size: 0.875rem; opacity: 0.8;">
                                ${formatTime(r.created)}
                            </span>
                        </div>
                        <p>${r.content}</p>
                    </div>
                `).join('');
            }
            
            // Clear the reply input
            document.getElementById(`reply-content-${discussionId}`).value = '';
            
            showToast('Reply posted!', 'success');
            addNotification('comment', `You replied to "${discussion.title}"`);
        }

        // ============================================
        // FILE HANDLING FUNCTIONALITY
        // ============================================
        const uploadedFiles = {
            project: [],
            lesson: [],
            discussion: []
        };
        
        function handleFileSelect(event, type) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById(`${type}-files-preview`);
            
            if (!preview) return;
            
            // Clear previous selection
            uploadedFiles[type] = [];
            preview.innerHTML = '';
            
            // Validate and process files
            files.forEach(file => {
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`File "${file.name}" exceeds 10MB limit`, 'error');
                    return;
                }
                
                // Store file info
                const fileInfo = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    lastModified: file.lastModified
                };
                
                // Read file content for preview
                const reader = new FileReader();
                
                if (file.type.startsWith('image/')) {
                    reader.onload = (e) => {
                        fileInfo.dataUrl = e.target.result;
                        fileInfo.isImage = true;
                        uploadedFiles[type].push(fileInfo);
                        addFilePreview(preview, fileInfo, type);
                    };
                    reader.readAsDataURL(file);
                } else {
                    // For non-image files, just store the info
                    uploadedFiles[type].push(fileInfo);
                    addFilePreview(preview, fileInfo, type);
                }
            });
        }
        
        function addFilePreview(preview, fileInfo, type) {
            const fileDiv = document.createElement('div');
            fileDiv.style = 'display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem; margin-bottom: 0.5rem;';
            
            const icon = getFileIcon(fileInfo.type);
            
            if (fileInfo.isImage && fileInfo.dataUrl) {
                fileDiv.innerHTML = `
                    <div style="width: 60px; height: 60px; background: url('${fileInfo.dataUrl}') center/cover; 
                                border-radius: 0.5rem;"></div>
                    <div style="flex: 1;">
                        <div style="color: var(--text); font-weight: 500;">${fileInfo.name}</div>
                        <div style="color: var(--text); opacity: 0.6; font-size: 0.875rem;">
                            ${formatFileSize(fileInfo.size)}
                        </div>
                    </div>
                    <button type="button" class="btn" style="padding: 0.25rem 0.5rem; background: var(--danger); color: white;" 
                            onclick="removeFile('${type}', '${fileInfo.name}')">
                        √ó
                    </button>
                `;
            } else {
                fileDiv.innerHTML = `
                    <div style="font-size: 2rem;">${icon}</div>
                    <div style="flex: 1;">
                        <div style="color: var(--text); font-weight: 500;">${fileInfo.name}</div>
                        <div style="color: var(--text); opacity: 0.6; font-size: 0.875rem;">
                            ${formatFileSize(fileInfo.size)} ‚Ä¢ ${getFileTypeLabel(fileInfo.type)}
                        </div>
                    </div>
                    <button type="button" class="btn" style="padding: 0.25rem 0.5rem; background: var(--danger); color: white;" 
                            onclick="removeFile('${type}', '${fileInfo.name}')">
                        √ó
                    </button>
                `;
            }
            
            preview.appendChild(fileDiv);
        }
        
        function removeFile(type, fileName) {
            uploadedFiles[type] = uploadedFiles[type].filter(f => f.name !== fileName);
            const preview = document.getElementById(`${type}-files-preview`);
            if (preview) {
                // Rebuild preview
                preview.innerHTML = '';
                uploadedFiles[type].forEach(file => addFilePreview(preview, file, type));
            }
        }
        
        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'üñºÔ∏è';
            if (fileType.includes('pdf')) return 'üìÑ';
            if (fileType.includes('zip') || fileType.includes('rar')) return 'üì¶';
            if (fileType.includes('video')) return 'üé•';
            if (fileType.includes('audio')) return 'üéµ';
            if (fileType.includes('text') || fileType.includes('document')) return 'üìù';
            if (fileType.includes('sheet') || fileType.includes('excel')) return 'üìä';
            if (fileType.includes('presentation') || fileType.includes('powerpoint')) return 'üìä';
            return 'üìé';
        }
        
        function getFileTypeLabel(fileType) {
            if (fileType.startsWith('image/')) return 'Image';
            if (fileType.includes('pdf')) return 'PDF';
            if (fileType.includes('zip')) return 'Archive';
            if (fileType.includes('video')) return 'Video';
            if (fileType.includes('audio')) return 'Audio';
            if (fileType.includes('javascript')) return 'JavaScript';
            if (fileType.includes('python')) return 'Python';
            if (fileType.includes('json')) return 'JSON';
            if (fileType.includes('html')) return 'HTML';
            if (fileType.includes('css')) return 'CSS';
            return fileType.split('/')[1]?.toUpperCase() || 'File';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // ============================================
        // AUTO-SAVE & DRAFT SYSTEM
        // ============================================
        
        const drafts = {
            project: null,
            discussion: null,
            lesson: null,
            autoSaveInterval: null
        };
        
        function startAutoSave(type, formElement) {
            // Clear any existing interval
            if (drafts.autoSaveInterval) {
                clearInterval(drafts.autoSaveInterval);
            }
            
            // Auto-save every 30 seconds
            drafts.autoSaveInterval = setInterval(() => {
                saveDraft(type, formElement);
            }, 30000);
            
            // Also save on input change
            formElement.addEventListener('input', () => {
                clearTimeout(drafts.saveTimeout);
                drafts.saveTimeout = setTimeout(() => {
                    saveDraft(type, formElement);
                }, 2000);
            });
        }
        
        function saveDraft(type, formElement) {
            const formData = new FormData(formElement);
            const draft = {};
            formData.forEach((value, key) => {
                draft[key] = value;
            });
            
            draft.timestamp = new Date().toISOString();
            drafts[type] = draft;
            localStorage.setItem(`aiHub_draft_${type}`, JSON.stringify(draft));
            
            // Show save indicator
            showToast('Draft saved', 'info', 1000);
        }
        
        function loadDraft(type) {
            const saved = localStorage.getItem(`aiHub_draft_${type}`);
            if (saved) {
                drafts[type] = JSON.parse(saved);
                return drafts[type];
            }
            return null;
        }
        
        function clearDraft(type) {
            drafts[type] = null;
            localStorage.removeItem(`aiHub_draft_${type}`);
            if (drafts.autoSaveInterval) {
                clearInterval(drafts.autoSaveInterval);
            }
        }
        
        // ============================================
        // GLOBAL SEARCH SYSTEM
        // ============================================
        
        let searchHistory = JSON.parse(localStorage.getItem('aiHub_searchHistory') || '[]');
        let searchSuggestions = [];
        
        function showGlobalSearch() {
            const modal = createModal('üîç Global Search', `
                <div style="position: relative;">
                    <input type="text" id="global-search-input" placeholder="Search everything..." 
                           style="width: 100%; padding: 1rem; font-size: 1.2rem; background: rgba(255,255,255,0.05); 
                                  border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: var(--text);"
                           oninput="handleGlobalSearch(this.value)" 
                           onkeydown="handleSearchKeydown(event)">
                    
                    <div id="search-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; 
                                                        background: var(--bg-card); border-radius: 0.5rem; 
                                                        margin-top: 0.5rem; max-height: 300px; overflow-y: auto; 
                                                        display: none; z-index: 1000;">
                    </div>
                </div>
                
                <div id="global-search-results" style="margin-top: 2rem;">
                    <h3 style="color: var(--text); opacity: 0.6;">Recent Searches</h3>
                    ${searchHistory.slice(0, 5).map(term => `
                        <div class="activity-item" onclick="searchFromHistory('${term}')" style="cursor: pointer;">
                            <div class="activity-icon">üïê</div>
                            <div class="activity-content">${term}</div>
                        </div>
                    `).join('') || '<p style="opacity: 0.6;">No recent searches</p>'}
                </div>
            `);
            
            document.body.appendChild(modal);
            document.getElementById('global-search-input').focus();
        }
        
        function handleGlobalSearch(query) {
            if (query.length < 2) {
                document.getElementById('search-suggestions').style.display = 'none';
                return;
            }
            
            // Generate suggestions
            const suggestions = generateSearchSuggestions(query);
            const suggestionsDiv = document.getElementById('search-suggestions');
            
            if (suggestions.length > 0) {
                suggestionsDiv.innerHTML = suggestions.map((s, i) => `
                    <div class="search-suggestion" data-index="${i}" 
                         style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1);"
                         onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                         onmouseout="this.style.background='transparent'"
                         onclick="selectSuggestion('${s.text}')">
                        <span style="color: var(--primary);">${s.icon}</span> ${s.text}
                        <span style="opacity: 0.6; font-size: 0.875rem; margin-left: 0.5rem;">${s.type}</span>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
            
            // Perform search
            performGlobalSearch(query);
        }
        
        function generateSearchSuggestions(query) {
            const suggestions = [];
            const lowerQuery = query.toLowerCase();
            
            // Search in projects
            APP_STATE.projects.forEach(p => {
                if (p.title.toLowerCase().includes(lowerQuery)) {
                    suggestions.push({ text: p.title, type: 'Project', icon: 'üìÅ' });
                }
            });
            
            // Search in users
            ['Alice Dev', 'Bob Builder', 'Carol Charts'].forEach(user => {
                if (user.toLowerCase().includes(lowerQuery)) {
                    suggestions.push({ text: user, type: 'User', icon: 'üë§' });
                }
            });
            
            // Add common searches
            ['Python', 'JavaScript', 'AI', 'Machine Learning'].forEach(term => {
                if (term.toLowerCase().includes(lowerQuery)) {
                    suggestions.push({ text: term, type: 'Topic', icon: 'üè∑Ô∏è' });
                }
            });
            
            return suggestions.slice(0, 5);
        }
        
        function performGlobalSearch(query) {
            const results = {
                projects: [],
                discussions: [],
                users: [],
                lessons: []
            };
            
            const lowerQuery = query.toLowerCase();
            
            // Search projects
            results.projects = APP_STATE.projects.filter(p => 
                p.title.toLowerCase().includes(lowerQuery) ||
                p.description.toLowerCase().includes(lowerQuery)
            );
            
            // Search discussions
            results.discussions = APP_STATE.discussions.filter(d => 
                d.title.toLowerCase().includes(lowerQuery) ||
                d.content.toLowerCase().includes(lowerQuery)
            );
            
            // Display results
            const resultsDiv = document.getElementById('global-search-results');
            resultsDiv.innerHTML = `
                <h3 style="color: var(--text); margin-bottom: 1rem;">Search Results for "${query}"</h3>
                
                ${results.projects.length > 0 ? `
                    <h4 style="color: var(--primary); margin: 1rem 0;">Projects (${results.projects.length})</h4>
                    ${results.projects.map(p => `
                        <div class="activity-item" onclick="navigateTo('projects'); closeModal();" style="cursor: pointer;">
                            <div class="activity-icon">üìÅ</div>
                            <div class="activity-content">
                                <strong>${p.title}</strong>
                                <div style="font-size: 0.875rem; opacity: 0.8;">${p.description}</div>
                            </div>
                        </div>
                    `).join('')}
                ` : ''}
                
                ${results.discussions.length > 0 ? `
                    <h4 style="color: var(--primary); margin: 1rem 0;">Discussions (${results.discussions.length})</h4>
                    ${results.discussions.map(d => `
                        <div class="activity-item" onclick="navigateTo('discussions'); closeModal();" style="cursor: pointer;">
                            <div class="activity-icon">üí¨</div>
                            <div class="activity-content">
                                <strong>${d.title}</strong>
                                <div style="font-size: 0.875rem; opacity: 0.8;">${d.content.substring(0, 100)}...</div>
                            </div>
                        </div>
                    `).join('')}
                ` : ''}
                
                ${results.projects.length === 0 && results.discussions.length === 0 ? 
                    '<p style="text-align: center; opacity: 0.6; padding: 2rem;">No results found</p>' : ''}
            `;
            
            // Save to search history
            if (query.length > 2 && !searchHistory.includes(query)) {
                searchHistory.unshift(query);
                searchHistory = searchHistory.slice(0, 10);
                localStorage.setItem('aiHub_searchHistory', JSON.stringify(searchHistory));
            }
        }
        
        // ============================================
        // COLLABORATION FEATURES
        // ============================================
        
        function forkProject(projectId) {
            const project = APP_STATE.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const forkedProject = {
                ...project,
                id: 'proj_fork_' + Date.now(),
                title: project.title + ' (Fork)',
                author: APP_STATE.currentUser.username,
                authorId: APP_STATE.currentUser.id,
                forkedFrom: projectId,
                created: new Date().toISOString(),
                likes: 0,
                stars: 0,
                comments: []
            };
            
            APP_STATE.projects.push(forkedProject);
            saveAppData('projects', APP_STATE.projects);
            showToast('Project forked successfully!', 'success');
            navigateTo('projects');
        }
        
        // ============================================
        // LEARNING ENHANCEMENTS
        // ============================================
        
        const learningProgress = {
            lessons: new Map(),
            bookmarks: [],
            notes: new Map()
        };
        
        function trackLessonProgress(lessonId, progress) {
            learningProgress.lessons.set(lessonId, {
                progress: progress,
                lastAccessed: new Date().toISOString()
            });
            localStorage.setItem('aiHub_lessonProgress', JSON.stringify(Array.from(learningProgress.lessons)));
        }
        
        function addBookmark(type, id, title) {
            const bookmark = {
                type: type,
                id: id,
                title: title,
                created: new Date().toISOString()
            };
            learningProgress.bookmarks.push(bookmark);
            localStorage.setItem('aiHub_bookmarks', JSON.stringify(learningProgress.bookmarks));
            showToast('Bookmarked!', 'success');
        }
        
        function addNote(itemId, note) {
            if (!learningProgress.notes.has(itemId)) {
                learningProgress.notes.set(itemId, []);
            }
            learningProgress.notes.get(itemId).push({
                content: note,
                created: new Date().toISOString()
            });
            localStorage.setItem('aiHub_notes', JSON.stringify(Array.from(learningProgress.notes)));
        }
        
        // ============================================
        // SOCIAL FEATURES
        // ============================================
        
        function parseMentions(text) {
            const mentionRegex = /@(\w+)/g;
            return text.replace(mentionRegex, '<span class="mention" style="color: var(--primary); cursor: pointer;">@$1</span>');
        }
        
        function parseHashtags(text) {
            const hashtagRegex = /#(\w+)/g;
            return text.replace(hashtagRegex, '<span class="hashtag" style="color: var(--secondary); cursor: pointer;">#$1</span>');
        }
        
        function shareToSocial(platform, content) {
            const urls = {
                twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(content)}`,
                linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`
            };
            
            if (urls[platform]) {
                window.open(urls[platform], '_blank', 'width=600,height=400');
            }
        }
        
        // ============================================
        // PRODUCTIVITY TOOLS
        // ============================================
        
        let pomodoroTimer = null;
        let pomodoroMinutes = 25;
        
        function startPomodoro() {
            const modal = createModal('üçÖ Pomodoro Timer', `
                <div style="text-align: center;">
                    <div id="pomodoro-display" style="font-size: 4rem; color: var(--primary); margin: 2rem 0;">
                        25:00
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem;">
                        <button class="btn btn-primary" onclick="togglePomodoro()">
                            <span id="pomodoro-btn-text">Start</span>
                        </button>
                        <button class="btn btn-secondary" onclick="resetPomodoro()">
                            Reset
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button class="btn btn-secondary" onclick="setPomodoroTime(25)">25 min</button>
                        <button class="btn btn-secondary" onclick="setPomodoroTime(15)">15 min</button>
                        <button class="btn btn-secondary" onclick="setPomodoroTime(5)">5 min</button>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }
        
        function togglePomodoro() {
            if (pomodoroTimer) {
                clearInterval(pomodoroTimer);
                pomodoroTimer = null;
                document.getElementById('pomodoro-btn-text').textContent = 'Start';
            } else {
                let seconds = pomodoroMinutes * 60;
                pomodoroTimer = setInterval(() => {
                    seconds--;
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    document.getElementById('pomodoro-display').textContent = 
                        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    
                    if (seconds <= 0) {
                        clearInterval(pomodoroTimer);
                        pomodoroTimer = null;
                        showToast('Pomodoro completed! Take a break!', 'success');
                        document.getElementById('pomodoro-btn-text').textContent = 'Start';
                    }
                }, 1000);
                document.getElementById('pomodoro-btn-text').textContent = 'Pause';
            }
        }
        
        // ============================================
        // ACCESSIBILITY FEATURES
        // ============================================
        
        function toggleHighContrast() {
            document.body.classList.toggle('high-contrast');
            localStorage.setItem('aiHub_highContrast', document.body.classList.contains('high-contrast'));
        }
        
        function adjustFontSize(delta) {
            const currentSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size'));
            const newSize = Math.max(12, Math.min(24, currentSize + delta));
            document.documentElement.style.setProperty('--font-size', newSize + 'px');
            document.body.style.fontSize = newSize + 'px';
            localStorage.setItem('aiHub_fontSize', newSize);
        }
        
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }
        
        // Back to top button
        function addBackToTopButton() {
            const button = document.createElement('button');
            button.id = 'back-to-top';
            button.innerHTML = '‚Üë';
            button.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: var(--primary);
                color: white;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                display: none;
                z-index: 1000;
                transition: var(--transition);
            `;
            
            button.onclick = () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            
            window.addEventListener('scroll', () => {
                button.style.display = window.scrollY > 300 ? 'block' : 'none';
            });
            
            document.body.appendChild(button);
        }
        
        // ============================================
        // COMMUNICATION ENHANCEMENTS
        // ============================================
        
        function addEmojiReaction(messageId, emoji) {
            // Add emoji reaction to message
            const message = document.querySelector(`[data-message-id="${messageId}"]`);
            if (message) {
                let reactionsDiv = message.querySelector('.reactions');
                if (!reactionsDiv) {
                    reactionsDiv = document.createElement('div');
                    reactionsDiv.className = 'reactions';
                    reactionsDiv.style.cssText = 'display: flex; gap: 0.5rem; margin-top: 0.5rem;';
                    message.appendChild(reactionsDiv);
                }
                
                const reaction = document.createElement('span');
                reaction.style.cssText = 'background: rgba(255,255,255,0.1); padding: 0.25rem 0.5rem; border-radius: 1rem; cursor: pointer;';
                reaction.innerHTML = `${emoji} 1`;
                reactionsDiv.appendChild(reaction);
            }
        }
        
        function startVideoCall(roomId) {
            showToast('Video call starting...', 'info');
            // In production, this would integrate with WebRTC
        }
        
        function sendVoiceMessage() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        const mediaRecorder = new MediaRecorder(stream);
                        const audioChunks = [];
                        
                        mediaRecorder.ondataavailable = event => {
                            audioChunks.push(event.data);
                        };
                        
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks);
                            const audioUrl = URL.createObjectURL(audioBlob);
                            // Save or send the audio
                            showToast('Voice message recorded', 'success');
                        };
                        
                        mediaRecorder.start();
                        setTimeout(() => mediaRecorder.stop(), 5000); // 5 second limit
                    })
                    .catch(err => showToast('Microphone access denied', 'error'));
            }
        }
        
        // ============================================
        // ANALYTICS DASHBOARD
        // ============================================
        
        function showAnalyticsDashboard() {
            const timeSpent = parseInt(localStorage.getItem('aiHub_timeSpent') || '0');
            const pageViews = JSON.parse(localStorage.getItem('aiHub_pageViews') || '{}');
            
            const modal = createModal('üìä Analytics Dashboard', `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; color: var(--primary);">${Math.floor(timeSpent / 60)}</div>
                        <div>Minutes Spent</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; color: var(--success);">${Object.keys(pageViews).length}</div>
                        <div>Pages Visited</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; color: var(--warning);">${APP_STATE.projects.length}</div>
                        <div>Projects Created</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; color: var(--secondary);">${APP_STATE.friends.size}</div>
                        <div>Friends Added</div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary); margin-bottom: 1rem;">Activity Heatmap</h3>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem;">
                    ${Array(35).fill(0).map((_, i) => `
                        <div style="aspect-ratio: 1; background: rgba(124, 58, 237, ${Math.random() * 0.8}); 
                                    border-radius: 0.25rem;" title="Activity level"></div>
                    `).join('')}
                </div>
                
                <button class="btn btn-secondary" style="margin-top: 2rem; width: 100%;" 
                        onclick="exportAnalytics()">
                    üì• Export Report
                </button>
            `);
            
            document.body.appendChild(modal);
        }
        
        function exportAnalytics() {
            const report = {
                timeSpent: localStorage.getItem('aiHub_timeSpent'),
                pageViews: localStorage.getItem('aiHub_pageViews'),
                projects: APP_STATE.projects.length,
                friends: APP_STATE.friends.size,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics_${Date.now()}.json`;
            a.click();
        }
        
        // ============================================
        // SECURITY & PRIVACY
        // ============================================
        
        function showPrivacySettings() {
            const modal = createModal('üîí Privacy Settings', `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <label style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="profile-public" ${APP_STATE.currentUser?.publicProfile ? 'checked' : ''}>
                        <span>Public Profile</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="show-activity" ${APP_STATE.currentUser?.showActivity ? 'checked' : ''}>
                        <span>Show Activity Status</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 1rem;">
                        <input type="checkbox" id="allow-messages" ${APP_STATE.currentUser?.allowMessages ? 'checked' : ''}>
                        <span>Allow Messages from Non-Friends</span>
                    </label>
                    
                    <h3 style="color: var(--primary); margin-top: 2rem;">Blocked Users</h3>
                    <div id="blocked-users-list">
                        ${APP_STATE.blockedUsers.size === 0 ? '<p style="opacity: 0.6;">No blocked users</p>' : 
                          Array.from(APP_STATE.blockedUsers).map(userId => `
                            <div style="display: flex; justify-content: space-between; align-items: center; 
                                        padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem;">
                                <span>User ${userId}</span>
                                <button class="btn btn-secondary" onclick="unblockUser('${userId}')">Unblock</button>
                            </div>
                          `).join('')}
                    </div>
                    
                    <button class="btn btn-primary" style="margin-top: 2rem;" onclick="savePrivacySettings()">
                        Save Settings
                    </button>
                </div>
            `);
            
            document.body.appendChild(modal);
        }
        
        function blockUser(userId) {
            APP_STATE.blockedUsers.add(userId);
            saveAppData('blockedUsers', Array.from(APP_STATE.blockedUsers));
            showToast('User blocked', 'success');
        }
        
        function unblockUser(userId) {
            APP_STATE.blockedUsers.delete(userId);
            saveAppData('blockedUsers', Array.from(APP_STATE.blockedUsers));
            showToast('User unblocked', 'success');
        }
        
        // ============================================
        // PERSONALIZATION
        // ============================================
        
        function getRecommendedProjects() {
            // Simple recommendation based on tech stack
            const userTech = new Set();
            APP_STATE.projects
                .filter(p => p.authorId === APP_STATE.currentUser?.id)
                .forEach(p => (p.tech || []).forEach(t => userTech.add(t)));
            
            return APP_STATE.projects
                .filter(p => p.authorId !== APP_STATE.currentUser?.id)
                .filter(p => (p.tech || []).some(t => userTech.has(t)))
                .slice(0, 3);
        }
        
        function showCustomThemes() {
            const modal = createModal('üé® Custom Themes', `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div class="card" style="cursor: pointer; text-align: center;" onclick="applyTheme('default')">
                        <div style="width: 100%; height: 60px; background: linear-gradient(135deg, #7c3aed, #3b82f6); 
                                    border-radius: 0.5rem; margin-bottom: 0.5rem;"></div>
                        <span>Default</span>
                    </div>
                    
                    <div class="card" style="cursor: pointer; text-align: center;" onclick="applyTheme('ocean')">
                        <div style="width: 100%; height: 60px; background: linear-gradient(135deg, #0891b2, #0e7490); 
                                    border-radius: 0.5rem; margin-bottom: 0.5rem;"></div>
                        <span>Ocean</span>
                    </div>
                    
                    <div class="card" style="cursor: pointer; text-align: center;" onclick="applyTheme('forest')">
                        <div style="width: 100%; height: 60px; background: linear-gradient(135deg, #059669, #047857); 
                                    border-radius: 0.5rem; margin-bottom: 0.5rem;"></div>
                        <span>Forest</span>
                    </div>
                    
                    <div class="card" style="cursor: pointer; text-align: center;" onclick="applyTheme('sunset')">
                        <div style="width: 100%; height: 60px; background: linear-gradient(135deg, #f59e0b, #dc2626); 
                                    border-radius: 0.5rem; margin-bottom: 0.5rem;"></div>
                        <span>Sunset</span>
                    </div>
                </div>
            `);
            
            document.body.appendChild(modal);
        }
        
        function applyTheme(themeName) {
            const themes = {
                default: { primary: '#7c3aed', secondary: '#3b82f6' },
                ocean: { primary: '#0891b2', secondary: '#0e7490' },
                forest: { primary: '#059669', secondary: '#047857' },
                sunset: { primary: '#f59e0b', secondary: '#dc2626' }
            };
            
            if (themes[themeName]) {
                document.documentElement.style.setProperty('--primary', themes[themeName].primary);
                document.documentElement.style.setProperty('--secondary', themes[themeName].secondary);
                localStorage.setItem('aiHub_customTheme', themeName);
                showToast(`${themeName} theme applied!`, 'success');
            }
        }
        
        // ============================================
        // CONTENT MANAGEMENT
        // ============================================
        
        function showRichTextEditor(contentId) {
            const modal = createModal('üìù Rich Text Editor', `
                <div id="editor-toolbar" style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="formatText('bold')"><b>B</b></button>
                    <button class="btn btn-secondary" onclick="formatText('italic')"><i>I</i></button>
                    <button class="btn btn-secondary" onclick="formatText('underline')"><u>U</u></button>
                    <button class="btn btn-secondary" onclick="formatText('code')">&lt;/&gt;</button>
                    <button class="btn btn-secondary" onclick="insertLink()">üîó</button>
                    <button class="btn btn-secondary" onclick="insertImage()">üñºÔ∏è</button>
                    <button class="btn btn-secondary" onclick="insertCodeBlock()">{ }</button>
                </div>
                
                <div contenteditable="true" id="rich-editor" 
                     style="min-height: 300px; padding: 1rem; background: rgba(255,255,255,0.05); 
                            border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem;">
                    Start typing...
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="saveRichContent('${contentId}')">Save</button>
                    <button class="btn btn-secondary" onclick="previewMarkdown()">Preview</button>
                </div>
            `);
            
            document.body.appendChild(modal);
        }
        
        function formatText(command) {
            document.execCommand(command, false, null);
        }
        
        function insertCodeBlock() {
            const code = prompt('Enter your code:');
            if (code) {
                const pre = document.createElement('pre');
                const codeEl = document.createElement('code');
                codeEl.textContent = code;
                pre.appendChild(codeEl);
                document.getElementById('rich-editor').appendChild(pre);
            }
        }
        
        // Lazy loading for images
        function initLazyLoading() {
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                });
            });
            
            images.forEach(img => imageObserver.observe(img));
        }
        
        // Helper functions for new features
        function toggleSettingsMenu() {
            const dropdown = document.getElementById('settings-dropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function showAccessibilityMenu() {
            const modal = createModal('‚ôø Accessibility Settings', `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div>
                        <h3 style="color: var(--primary); margin-bottom: 1rem;">Font Size</h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button class="btn btn-secondary" onclick="adjustFontSize(-2)">A-</button>
                            <span id="font-size-display">${parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size'))}px</span>
                            <button class="btn btn-secondary" onclick="adjustFontSize(2)">A+</button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: var(--primary); margin-bottom: 1rem;">Visual</h3>
                        <button class="btn btn-secondary" onclick="toggleHighContrast()" style="width: 100%;">
                            Toggle High Contrast
                        </button>
                    </div>
                    
                    <div>
                        <h3 style="color: var(--primary); margin-bottom: 1rem;">Audio</h3>
                        <button class="btn btn-secondary" onclick="testTextToSpeech()" style="width: 100%;">
                            üîä Test Text-to-Speech
                        </button>
                    </div>
                </div>
            `);
            document.body.appendChild(modal);
        }
        
        function testTextToSpeech() {
            speakText('Text to speech is working correctly.');
        }
        
        function resetPomodoro() {
            if (pomodoroTimer) {
                clearInterval(pomodoroTimer);
                pomodoroTimer = null;
            }
            document.getElementById('pomodoro-display').textContent = `${pomodoroMinutes}:00`;
            document.getElementById('pomodoro-btn-text').textContent = 'Start';
        }
        
        function setPomodoroTime(minutes) {
            pomodoroMinutes = minutes;
            resetPomodoro();
        }
        
        function savePrivacySettings() {
            APP_STATE.currentUser.publicProfile = document.getElementById('profile-public').checked;
            APP_STATE.currentUser.showActivity = document.getElementById('show-activity').checked;
            APP_STATE.currentUser.allowMessages = document.getElementById('allow-messages').checked;
            saveAppData('currentUser', APP_STATE.currentUser);
            showToast('Privacy settings saved', 'success');
            closeModal();
        }
        
        function selectSuggestion(text) {
            document.getElementById('global-search-input').value = text;
            performGlobalSearch(text);
        }
        
        function searchFromHistory(term) {
            document.getElementById('global-search-input').value = term;
            performGlobalSearch(term);
        }
        
        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                const query = event.target.value;
                performGlobalSearch(query);
                document.getElementById('search-suggestions').style.display = 'none';
            }
        }
        
        // Track time spent
        let sessionStart = Date.now();
        setInterval(() => {
            const timeSpent = parseInt(localStorage.getItem('aiHub_timeSpent') || '0');
            localStorage.setItem('aiHub_timeSpent', timeSpent + 1);
        }, 1000);
        
        // Track page views
        function trackPageView(page) {
            const pageViews = JSON.parse(localStorage.getItem('aiHub_pageViews') || '{}');
            pageViews[page] = (pageViews[page] || 0) + 1;
            localStorage.setItem('aiHub_pageViews', JSON.stringify(pageViews));
        }

        // ============================================
        // IMPORT/EXPORT FUNCTIONALITY
        // ============================================
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // Import data with confirmation
                        if (confirm('This will replace all your current data. Continue?')) {
                            Object.keys(data).forEach(key => {
                                if (key !== 'exportDate') {
                                    localStorage.setItem(`aiHub_${key}`, JSON.stringify(data[key]));
                                }
                            });
                            
                            showToast('Data imported successfully!', 'success');
                            // Reload page to apply imported data
                            setTimeout(() => location.reload(), 1000);
                        }
                    } catch (error) {
                        showToast('Failed to import data: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Don't trigger shortcuts when typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                // Alt + number for navigation
                if (e.altKey) {
                    switch(e.key) {
                        case '1': navigateTo('home'); break;
                        case '2': navigateTo('projects'); break;
                        case '3': navigateTo('lessons'); break;
                        case '4': navigateTo('discussions'); break;
                        case '5': navigateTo('collaborate'); break;
                        case '6': navigateTo('profile'); break;
                        case '7': navigateTo('friends'); break;
                        case 'n': showCreateProjectModal(); break;
                        case 's': document.getElementById('project-search')?.focus(); break;
                        case 't': toggleTheme(); break;
                        case 'm': toggleMessagesWidget(); break;
                        case '?': showKeyboardShortcuts(); break;
                    }
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => modal.remove());
                }
            });
        }
        
        function showKeyboardShortcuts() {
            const modal = createModal('‚å®Ô∏è Keyboard Shortcuts', `
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 1rem; max-height: 400px; overflow-y: auto;">
                    <kbd style="background: var(--dark); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Alt + 1-7</kbd>
                    <span>Navigate to different pages</span>
                    
                    <kbd style="background: var(--dark); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Alt + N</kbd>
                    <span>Create new project</span>
                    
                    <kbd style="background: var(--dark); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Alt + S</kbd>
                    <span>Focus search bar</span>
                    
                    <kbd style="background: var(--dark); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Alt + T</kbd>
                    <span>Toggle theme</span>
                    
                    <kbd style="background: var(--dark); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Alt + M</kbd>
                    <span>Toggle messages</span>
                    
                    <kbd style="background: var(--dark); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Alt + ?</kbd>
                    <span>Show this help</span>
                    
                    <kbd style="background: var(--dark); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Escape</kbd>
                    <span>Close modals</span>
                </div>
            `);
            document.body.appendChild(modal);
        }
        
        // ============================================
        // TECH TAG FILTERING
        // ============================================
        
        function filterByTechTag(tag) {
            const searchInput = document.getElementById('project-search');
            if (searchInput) {
                searchInput.value = tag;
                window.searchProjects(tag);
            }
        }
        
        // ============================================
        // ACHIEVEMENT SYSTEM
        // ============================================
        
        const ACHIEVEMENTS = {
            firstProject: { id: 'first_project', name: 'First Steps', desc: 'Create your first project', icon: 'üéØ', points: 10 },
            fiveProjects: { id: 'five_projects', name: 'Prolific Creator', desc: 'Create 5 projects', icon: 'üèóÔ∏è', points: 25 },
            tenLikes: { id: 'ten_likes', name: 'Popular', desc: 'Get 10 likes on your projects', icon: '‚ù§Ô∏è', points: 20 },
            firstFriend: { id: 'first_friend', name: 'Social Butterfly', desc: 'Add your first friend', icon: 'ü¶ã', points: 15 },
            helpOthers: { id: 'help_others', name: 'Helper', desc: 'Comment on 5 projects', icon: 'ü§ù', points: 20 },
            earlyBird: { id: 'early_bird', name: 'Early Bird', desc: 'Log in 7 days in a row', icon: 'üåÖ', points: 30 },
            nightOwl: { id: 'night_owl', name: 'Night Owl', desc: 'Use the platform after midnight', icon: 'ü¶â', points: 10 },
            collaborator: { id: 'collaborator', name: 'Team Player', desc: 'Join 3 collaboration rooms', icon: 'üë•', points: 25 }
        };
        
        function checkAchievements() {
            if (!APP_STATE.currentUser) return;
            
            const userAchievements = APP_STATE.currentUser.achievements || [];
            const userProjects = APP_STATE.projects.filter(p => p.authorId === APP_STATE.currentUser.id);
            
            // Check first project
            if (userProjects.length >= 1 && !userAchievements.includes('first_project')) {
                unlockAchievement('firstProject');
            }
            
            // Check five projects
            if (userProjects.length >= 5 && !userAchievements.includes('five_projects')) {
                unlockAchievement('fiveProjects');
            }
            
            // Check likes
            const totalLikes = userProjects.reduce((sum, p) => sum + (p.likes || 0), 0);
            if (totalLikes >= 10 && !userAchievements.includes('ten_likes')) {
                unlockAchievement('tenLikes');
            }
            
            // Check friends
            if (APP_STATE.friends.size >= 1 && !userAchievements.includes('first_friend')) {
                unlockAchievement('firstFriend');
            }
            
            // Check night owl (after midnight)
            const hour = new Date().getHours();
            if (hour >= 0 && hour < 6 && !userAchievements.includes('night_owl')) {
                unlockAchievement('nightOwl');
            }
        }
        
        function unlockAchievement(achievementKey) {
            const achievement = ACHIEVEMENTS[achievementKey];
            if (!achievement) return;
            
            if (!APP_STATE.currentUser.achievements) {
                APP_STATE.currentUser.achievements = [];
            }
            
            if (!APP_STATE.currentUser.achievements.includes(achievement.id)) {
                APP_STATE.currentUser.achievements.push(achievement.id);
                APP_STATE.currentUser.points = (APP_STATE.currentUser.points || 0) + achievement.points;
                
                saveAppData('currentUser', APP_STATE.currentUser);
                
                // Show achievement notification
                showAchievementUnlock(achievement);
            }
        }
        
        function showAchievementUnlock(achievement) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, var(--primary), var(--secondary));
                color: white;
                padding: 1.5rem;
                border-radius: 1rem;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideInRight 0.5s, pulse 2s infinite;
                max-width: 300px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 3rem;">${achievement.icon}</div>
                    <div>
                        <div style="font-weight: bold; font-size: 1.1rem;">Achievement Unlocked!</div>
                        <div style="font-size: 0.9rem; margin: 0.25rem 0;">${achievement.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">${achievement.desc}</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">+${achievement.points} points</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }
        
        function showAchievements() {
            const userAchievements = APP_STATE.currentUser?.achievements || [];
            const totalPoints = APP_STATE.currentUser?.points || 0;
            
            const modal = createModal('üèÜ Achievements', `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 2rem; color: var(--primary);">${totalPoints}</div>
                    <div style="color: var(--text); opacity: 0.8;">Total Points</div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                    ${Object.values(ACHIEVEMENTS).map(a => `
                        <div class="card" style="text-align: center; padding: 1rem; 
                             ${userAchievements.includes(a.id) ? '' : 'opacity: 0.3; filter: grayscale(1);'}">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">${a.icon}</div>
                            <div style="font-weight: bold; font-size: 0.9rem;">${a.name}</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">${a.desc}</div>
                            <div style="font-size: 0.75rem; color: var(--primary); margin-top: 0.5rem;">${a.points} pts</div>
                        </div>
                    `).join('')}
                </div>
            `);
            
            document.body.appendChild(modal);
        }

        // ============================================
        // PAGINATION SYSTEM
        // ============================================
        
        const ITEMS_PER_PAGE = 9;
        const currentPage = {
            projects: 1,
            discussions: 1,
            rooms: 1
        };
        
        function paginateItems(items, page, perPage = ITEMS_PER_PAGE) {
            const start = (page - 1) * perPage;
            const end = start + perPage;
            return {
                items: items.slice(start, end),
                totalPages: Math.ceil(items.length / perPage),
                currentPage: page
            };
        }
        
        function renderPagination(totalPages, currentPageNum, type) {
            if (totalPages <= 1) return '';
            
            let html = '<div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem; grid-column: 1 / -1;">';
            
            // Previous button
            html += `<button class="btn btn-secondary" onclick="changePage('${type}', ${currentPageNum - 1})" 
                     ${currentPageNum === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>‚Üê</button>`;
            
            // Page numbers
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                html += `<button class="btn ${i === currentPageNum ? 'btn-primary' : 'btn-secondary'}" 
                         onclick="changePage('${type}', ${i})">${i}</button>`;
            }
            
            if (totalPages > 5) {
                html += '<span style="padding: 0.5rem;">...</span>';
                html += `<button class="btn ${totalPages === currentPageNum ? 'btn-primary' : 'btn-secondary'}" 
                         onclick="changePage('${type}', ${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button class="btn btn-secondary" onclick="changePage('${type}', ${currentPageNum + 1})" 
                     ${currentPageNum === totalPages ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>‚Üí</button>`;
            
            html += '</div>';
            return html;
        }
        
        function changePage(type, page) {
            currentPage[type] = page;
            if (type === 'projects') {
                window.searchProjects(document.getElementById('project-search')?.value || '');
            } else if (type === 'rooms') {
                window.searchRooms(document.getElementById('room-search')?.value || '');
            }
        }

        // ============================================
        // STATISTICS AND ANALYTICS  
        // ============================================
        
        function showProjectStats() {
            if (!APP_STATE.currentUser) {
                showToast('Please sign in to view statistics', 'error');
                return;
            }
            
            const userProjects = APP_STATE.projects.filter(p => p.authorId === APP_STATE.currentUser?.id);
            const totalLikes = userProjects.reduce((sum, p) => sum + (p.likes || 0), 0);
            const totalStars = userProjects.reduce((sum, p) => sum + (p.stars || 0), 0);
            const totalComments = userProjects.reduce((sum, p) => sum + (p.comments?.length || 0), 0);
            
            const modal = createModal('üìä Project Statistics', `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem;">${userProjects.length}</div>
                        <div style="color: var(--text); opacity: 0.8;">Total Projects</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; color: var(--danger); margin-bottom: 0.5rem;">${totalLikes}</div>
                        <div style="color: var(--text); opacity: 0.8;">Total Likes</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; color: var(--warning); margin-bottom: 0.5rem;">${totalStars}</div>
                        <div style="color: var(--text); opacity: 0.8;">Total Stars</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; color: var(--secondary); margin-bottom: 0.5rem;">${totalComments}</div>
                        <div style="color: var(--text); opacity: 0.8;">Total Comments</div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary); margin-bottom: 1rem;">üìà Popular Projects</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${userProjects.length === 0 ? '<p>No projects yet. Create your first project!</p>' : 
                      userProjects.sort((a, b) => ((b.likes || 0) + (b.stars || 0)) - ((a.likes || 0) + (a.stars || 0)))
                        .slice(0, 5)
                        .map((p, i) => `
                            <div class="activity-item">
                                <div class="activity-icon">${i + 1}</div>
                                <div class="activity-content">
                                    <div><strong>${p.title}</strong></div>
                                    <div class="activity-time">‚ù§Ô∏è ${p.likes || 0} | ‚≠ê ${p.stars || 0} | üí¨ ${p.comments?.length || 0}</div>
                                </div>
                            </div>
                        `).join('')}
                </div>
            `);
            
            document.body.appendChild(modal);
        }

        // ============================================
        // SIMPLE SEARCH FUNCTIONS
        // ============================================
        
        window.searchProjects = function(searchTerm) {
            console.log('Searching projects for:', searchTerm);
            const grid = document.getElementById('projects-grid');
            if (!grid) return;
            
            // Get all projects
            let filtered = APP_STATE.projects || [];
            
            // Filter if search term exists
            if (searchTerm && searchTerm.trim() !== '') {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(project => {
                    return project.title.toLowerCase().includes(term) ||
                           project.description.toLowerCase().includes(term) ||
                           (project.author && project.author.toLowerCase().includes(term)) ||
                           (project.tech && project.tech.some(t => t.toLowerCase().includes(term)));
                });
            }
            
            // Apply pagination
            const paginated = paginateItems(filtered, currentPage.projects);
            
            // Display results
            if (paginated.items.length === 0 && currentPage.projects === 1) {
                grid.innerHTML = `
                    <div class="card" style="grid-column: 1 / -1; text-align: center;">
                        <p>No projects found${searchTerm ? ` for "${searchTerm}"` : ''}</p>
                    </div>`;
            } else {
                grid.innerHTML = paginated.items.map(project => createProjectCard(project)).join('') +
                                renderPagination(paginated.totalPages, paginated.currentPage, 'projects');
            }
        };
        
        window.searchRooms = function(searchTerm) {
            console.log('Searching rooms for:', searchTerm);
            const myRoomsContainer = document.getElementById('my-rooms');
            const publicRoomsContainer = document.getElementById('public-rooms');
            
            if (!myRoomsContainer || !publicRoomsContainer) return;
            
            let filtered = APP_STATE.rooms || [];
            
            if (searchTerm && searchTerm.trim() !== '') {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(room => {
                    return room.name.toLowerCase().includes(term) ||
                           room.description.toLowerCase().includes(term) ||
                           room.owner.toLowerCase().includes(term);
                });
            }
            
            // Split into my rooms and public rooms
            const myRooms = filtered.filter(r => r.ownerId === APP_STATE.currentUser?.id);
            const publicRooms = filtered.filter(r => !r.isPrivate && r.ownerId !== APP_STATE.currentUser?.id);
            
            // Display my rooms
            if (myRooms.length === 0) {
                myRoomsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; opacity: 0.6;">
                        <p>No rooms found</p>
                    </div>`;
            } else {
                myRoomsContainer.innerHTML = myRooms.map(room => renderRoomCard(room, true)).join('');
            }
            
            // Display public rooms
            if (publicRooms.length === 0) {
                publicRoomsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; opacity: 0.6;">
                        <p>No public rooms found</p>
                    </div>`;
            } else {
                publicRoomsContainer.innerHTML = publicRooms.map(room => renderRoomCard(room, false)).join('');
            }
        };
        
        window.searchFriends = function(searchTerm) {
            console.log('Searching friends for:', searchTerm);
            searchUsers(); // Use existing searchUsers function
        };

        // ============================================
        // ROOM & COLLABORATION FUNCTIONALITY
        // ============================================
        
        function showCreateRoomModal() {
            if (!APP_STATE.currentUser) {
                showAuthModal();
                return;
            }
            
            const modal = createModal('Create New Room', `
                <form onsubmit="createRoom(event)" style="font-size: 0.875rem;">
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Room Name *</label>
                        <input type="text" name="name" required maxlength="50"
                               placeholder="e.g., JavaScript Study Group"
                               style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05); 
                                      border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem; 
                                      color: var(--text); font-size: 0.8rem;">
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Description *</label>
                        <textarea name="description" required rows="2" maxlength="200"
                                  placeholder="What's this room about?"
                                  style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05); 
                                         border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem; 
                                         color: var(--text); font-size: 0.8rem; resize: none;"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Category *</label>
                            <select name="category" required
                                    style="width: 100%; padding: 0.4rem; background: #1e293b; 
                                           border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem; 
                                           color: var(--text); font-size: 0.8rem;">
                                <option value="study">üìö Study</option>
                                <option value="project">üíª Project</option>
                                <option value="social">üéâ Social</option>
                                <option value="help">üÜò Help</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Max People</label>
                            <input type="number" name="maxParticipants" min="2" max="20" value="8"
                                   style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05); 
                                          border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem; 
                                          color: var(--text); font-size: 0.8rem;">
                        </div>
                    </div>
                    
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.75rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; cursor: pointer;">
                                <input type="checkbox" name="enableVoice" checked style="margin: 0;">
                                <span>üé§ Voice</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; cursor: pointer;">
                                <input type="checkbox" name="enableScreen" checked style="margin: 0;">
                                <span>üñ•Ô∏è Screen</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; cursor: pointer;">
                                <input type="checkbox" name="isPrivate" style="margin: 0;">
                                <span>üîí Private</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">
                            ‚ûï Create Room
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" 
                                style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">
                            Cancel
                        </button>
                    </div>
                </form>
            `);
            
            // Adjust modal size
            modal.querySelector('.modal-content').style.maxWidth = '450px';
            modal.querySelector('.modal-content').style.maxHeight = 'fit-content';
            
            document.body.appendChild(modal);
        }
        
        async function createRoom(event) {
            event.preventDefault();
            const form = event.target;
            
            const roomData = {
                name: sanitizeInput(form.name.value),
                description: sanitizeInput(form.description.value),
                category: form.category.value,
                maxParticipants: parseInt(form.maxParticipants.value),
                enableVoice: form.enableVoice.checked,
                enableScreen: form.enableScreen.checked,
                isPrivate: form.isPrivate.checked,
                owner: APP_STATE.currentUser.username,
                ownerId: APP_STATE.currentUser.id,
                participants: [APP_STATE.currentUser.username]
            };
            
            // Try to create via API first
            let newRoom = await ApiService.createRoom(roomData);
            
            // If API fails, create locally
            if (!newRoom) {
                newRoom = {
                    id: 'room_' + Date.now(),
                    ...roomData,
                    created: new Date().toISOString(),
                    status: 'active',
                    messages: []
                };
                
                APP_STATE.rooms.push(newRoom);
                saveAppData('rooms', APP_STATE.rooms);
            } else {
                // Update local state with API response
                APP_STATE.rooms.push(newRoom);
            }
            
            closeModal();
            showToast('Room created successfully!', 'success');
            renderRooms();
            
            // Automatically join the created room
            joinRoom(newRoom.id);
        }
        
        function renderRooms() {
            const myRoomsContainer = document.getElementById('my-rooms');
            const publicRoomsContainer = document.getElementById('public-rooms');
            
            if (!myRoomsContainer || !publicRoomsContainer) return;
            
            const myRooms = APP_STATE.rooms.filter(r => 
                r.ownerId === APP_STATE.currentUser?.id
            );
            
            const publicRooms = APP_STATE.rooms.filter(r => 
                !r.isPrivate && r.ownerId !== APP_STATE.currentUser?.id
            );
            
            // Render My Rooms
            if (myRooms.length === 0) {
                myRoomsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; opacity: 0.6;">
                        <p>You haven't created any rooms yet</p>
                    </div>
                `;
            } else {
                myRoomsContainer.innerHTML = myRooms.map(room => renderRoomCard(room, true)).join('');
            }
            
            // Render Public Rooms
            if (publicRooms.length === 0) {
                publicRoomsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; opacity: 0.6;">
                        <p>No public rooms available</p>
                    </div>
                `;
            } else {
                publicRoomsContainer.innerHTML = publicRooms.map(room => renderRoomCard(room, false)).join('');
            }
        }
        
        function renderRoomCard(room, isOwner) {
            const categoryIcons = {
                study: 'üìö',
                project: 'üíª',
                social: 'üéâ',
                help: 'üÜò'
            };
            
            const statusColors = {
                active: '#10b981',
                waiting: '#f59e0b',
                full: '#ef4444'
            };
            
            const participantCount = room.participants ? room.participants.length : 0;
            const isFull = participantCount >= room.maxParticipants;
            const status = isFull ? 'full' : (participantCount > 0 ? 'active' : 'waiting');
            
            return `
                <div class="card room-card" style="cursor: pointer; transition: transform 0.3s; position: relative;"
                     onclick="joinRoom('${room.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <h3 style="color: var(--text); font-size: 1.125rem; margin: 0;">
                            ${categoryIcons[room.category]} ${room.name}
                        </h3>
                        <span style="background: ${statusColors[status]}; color: white; 
                                     padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                            ${status.toUpperCase()}
                        </span>
                    </div>
                    
                    <p style="color: var(--text); opacity: 0.8; margin-bottom: 1rem; font-size: 0.875rem;">
                        ${room.description}
                    </p>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        ${room.enableVoice ? '<span class="tech-tag">üé§ Voice</span>' : ''}
                        ${room.enableScreen ? '<span class="tech-tag">üñ•Ô∏è Screen</span>' : ''}
                        ${room.isPrivate ? '<span class="tech-tag">üîí Private</span>' : ''}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text); opacity: 0.6; font-size: 0.875rem;">
                            üë• ${participantCount}/${room.maxParticipants}
                        </span>
                        <span style="color: var(--text); opacity: 0.6; font-size: 0.875rem;">
                            by ${room.owner}
                        </span>
                    </div>
                    
                    ${isOwner ? `
                        <div style="position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem;">
                            <button onclick="event.stopPropagation(); editRoom('${room.id}')" 
                                    class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="event.stopPropagation(); deleteRoom('${room.id}')" 
                                    class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                üóëÔ∏è
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function joinRoom(roomId) {
            if (!APP_STATE.currentUser) {
                showAuthModal();
                return;
            }
            
            const room = APP_STATE.rooms.find(r => r.id === roomId);
            if (!room) {
                showToast('Room not found', 'error');
                return;
            }
            
            if (room.participants.length >= room.maxParticipants && 
                !room.participants.includes(APP_STATE.currentUser.username)) {
                showToast('Room is full', 'error');
                return;
            }
            
            // Add user to participants if not already in
            if (!room.participants.includes(APP_STATE.currentUser.username)) {
                room.participants.push(APP_STATE.currentUser.username);
                saveAppData('rooms', APP_STATE.rooms);
            }
            
            APP_STATE.activeRoom = room;
            showRoomInterface(room);
        }
        
        function showRoomInterface(room) {
            const modal = createModal(room.name, `
                <div style="height: 70vh; display: flex; flex-direction: column;">
                    <!-- Room Header -->
                    <div style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h3 style="margin: 0; color: var(--text);">${room.name}</h3>
                            <span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; 
                                         border-radius: 0.25rem; font-size: 0.75rem;">
                                CONNECTED
                            </span>
                        </div>
                        <p style="margin: 0; opacity: 0.8; font-size: 0.875rem;">${room.description}</p>
                    </div>
                    
                    <!-- Main Content Area -->
                    <div style="flex: 1; display: flex; gap: 1rem; min-height: 0;">
                        <!-- Video/Screen Area -->
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div id="video-container" style="flex: 1; background: #000; border-radius: 0.5rem; 
                                                              display: flex; align-items: center; justify-content: center; 
                                                              position: relative; overflow: hidden;">
                                <video id="local-video" autoplay muted style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
                                <video id="remote-video" autoplay style="width: 100%; height: 100%; object-fit: cover; display: none;"></video>
                                <div id="screen-share" style="width: 100%; height: 100%; display: none;">
                                    <video id="screen-video" autoplay style="width: 100%; height: 100%; object-fit: contain;"></video>
                                </div>
                                <div id="no-video-placeholder" style="text-align: center; color: #666;">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìπ</div>
                                    <p>No video feed active</p>
                                </div>
                            </div>
                            
                            <!-- Controls -->
                            <div style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem; 
                                        margin-top: 1rem; display: flex; justify-content: center; gap: 1rem;">
                                ${room.enableVoice ? `
                                    <button id="toggle-mic" onclick="toggleMicrophone()" class="btn btn-secondary">
                                        üé§ Mic
                                    </button>
                                    <button id="toggle-camera" onclick="toggleCamera()" class="btn btn-secondary">
                                        üìπ Camera
                                    </button>
                                ` : ''}
                                ${room.enableScreen ? `
                                    <button id="toggle-screen" onclick="toggleScreenShare()" class="btn btn-secondary">
                                        üñ•Ô∏è Share Screen
                                    </button>
                                ` : ''}
                                <button onclick="leaveRoom()" class="btn btn-danger">
                                    üìû Leave Room
                                </button>
                            </div>
                        </div>
                        
                        <!-- Chat & Participants Sidebar -->
                        <div style="width: 300px; display: flex; flex-direction: column;">
                            <!-- Tabs -->
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <button onclick="switchRoomTab('chat')" id="room-chat-tab" 
                                        class="btn btn-secondary" style="flex: 1;">
                                    üí¨ Chat
                                </button>
                                <button onclick="switchRoomTab('participants')" id="room-participants-tab" 
                                        class="btn btn-secondary" style="flex: 1; opacity: 0.6;">
                                    üë• Users (${room.participants.length})
                                </button>
                            </div>
                            
                            <!-- Chat Content -->
                            <div id="room-chat-content" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                                <div id="room-messages" style="flex: 1; overflow-y: auto; padding: 1rem; 
                                                                background: rgba(0,0,0,0.2); border-radius: 0.5rem; 
                                                                margin-bottom: 1rem;">
                                    <!-- Messages will appear here -->
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="room-message-input" placeholder="Type a message..." 
                                           onkeypress="if(event.key === 'Enter') sendRoomMessage()"
                                           style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.05); 
                                                  border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; 
                                                  color: var(--text);">
                                    <button onclick="sendRoomMessage()" class="btn btn-primary">
                                        Send
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Participants Content -->
                            <div id="room-participants-content" style="flex: 1; display: none; overflow-y: auto; 
                                                                        padding: 1rem; background: rgba(0,0,0,0.2); 
                                                                        border-radius: 0.5rem;">
                                ${room.participants.map(user => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; 
                                                border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; 
                                                    background: var(--primary); display: flex; align-items: center; 
                                                    justify-content: center; font-weight: bold;">
                                            ${user.charAt(0).toUpperCase()}
                                        </div>
                                        <span style="flex: 1;">${user}</span>
                                        ${user === room.owner ? '<span style="color: var(--primary); font-size: 0.75rem;">HOST</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `, 'max-content');
            
            document.body.appendChild(modal);
            
            // Load existing messages
            loadRoomMessages(room.id);
            
            // Initialize WebRTC if voice/video is enabled
            if (room.enableVoice) {
                initializeWebRTC();
            }
        }
        
        function switchRoomTab(tab) {
            const chatTab = document.getElementById('room-chat-tab');
            const participantsTab = document.getElementById('room-participants-tab');
            const chatContent = document.getElementById('room-chat-content');
            const participantsContent = document.getElementById('room-participants-content');
            
            if (tab === 'chat') {
                chatTab.style.opacity = '1';
                participantsTab.style.opacity = '0.6';
                chatContent.style.display = 'flex';
                participantsContent.style.display = 'none';
            } else {
                chatTab.style.opacity = '0.6';
                participantsTab.style.opacity = '1';
                chatContent.style.display = 'none';
                participantsContent.style.display = 'block';
            }
        }
        
        function sendRoomMessage() {
            const input = document.getElementById('room-message-input');
            const messagesContainer = document.getElementById('room-messages');
            
            if (!input || !messagesContainer || !input.value.trim()) return;
            
            const message = {
                id: 'msg_' + Date.now(),
                text: sanitizeInput(input.value),
                sender: APP_STATE.currentUser.username,
                timestamp: new Date().toISOString()
            };
            
            // Add message to room
            if (APP_STATE.activeRoom) {
                if (!APP_STATE.activeRoom.messages) {
                    APP_STATE.activeRoom.messages = [];
                }
                APP_STATE.activeRoom.messages.push(message);
                saveAppData('rooms', APP_STATE.rooms);
            }
            
            // Display message
            const messageEl = document.createElement('div');
            messageEl.style.cssText = 'margin-bottom: 1rem;';
            messageEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <strong style="color: var(--primary);">${message.sender}</strong>
                    <span style="font-size: 0.75rem; opacity: 0.6;">${formatTime(message.timestamp)}</span>
                </div>
                <p style="margin: 0;">${message.text}</p>
            `;
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            input.value = '';
        }
        
        function loadRoomMessages(roomId) {
            const room = APP_STATE.rooms.find(r => r.id === roomId);
            const messagesContainer = document.getElementById('room-messages');
            
            if (!room || !messagesContainer) return;
            
            if (room.messages && room.messages.length > 0) {
                messagesContainer.innerHTML = room.messages.map(msg => `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <strong style="color: var(--primary);">${msg.sender}</strong>
                            <span style="font-size: 0.75rem; opacity: 0.6;">${formatTime(msg.timestamp)}</span>
                        </div>
                        <p style="margin: 0;">${msg.text}</p>
                    </div>
                `).join('');
            } else {
                messagesContainer.innerHTML = '<p style="text-align: center; opacity: 0.6;">No messages yet. Start the conversation!</p>';
            }
        }
        
        function leaveRoom() {
            if (APP_STATE.activeRoom) {
                // Remove user from participants
                const room = APP_STATE.rooms.find(r => r.id === APP_STATE.activeRoom.id);
                if (room) {
                    room.participants = room.participants.filter(p => p !== APP_STATE.currentUser.username);
                    saveAppData('rooms', APP_STATE.rooms);
                }
                
                // Clean up WebRTC connections
                cleanupWebRTC();
                
                APP_STATE.activeRoom = null;
            }
            
            closeModal();
            renderRooms();
        }
        
        function deleteRoom(roomId) {
            if (confirm('Are you sure you want to delete this room?')) {
                APP_STATE.rooms = APP_STATE.rooms.filter(r => r.id !== roomId);
                saveAppData('rooms', APP_STATE.rooms);
                showToast('Room deleted', 'success');
                renderRooms();
            }
        }
        
        function editRoom(roomId) {
            // Implementation for editing room details
            showToast('Edit functionality coming soon!', 'info');
        }
        
        function filterRooms() {
            const searchTerm = document.getElementById('room-search')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('room-filter')?.value || 'all';
            const statusFilter = document.getElementById('room-status')?.value || 'all';
            
            const filteredRooms = APP_STATE.rooms.filter(room => {
                const matchesSearch = room.name.toLowerCase().includes(searchTerm) || 
                                     room.description.toLowerCase().includes(searchTerm);
                const matchesCategory = categoryFilter === 'all' || room.category === categoryFilter;
                const participantCount = room.participants ? room.participants.length : 0;
                const isFull = participantCount >= room.maxParticipants;
                const status = isFull ? 'full' : (participantCount > 0 ? 'active' : 'waiting');
                const matchesStatus = statusFilter === 'all' || status === statusFilter;
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            // Re-render with filtered rooms
            const myRoomsContainer = document.getElementById('my-rooms');
            const publicRoomsContainer = document.getElementById('public-rooms');
            
            if (!myRoomsContainer || !publicRoomsContainer) return;
            
            const myFilteredRooms = filteredRooms.filter(r => r.ownerId === APP_STATE.currentUser?.id);
            const publicFilteredRooms = filteredRooms.filter(r => !r.isPrivate && r.ownerId !== APP_STATE.currentUser?.id);
            
            if (myFilteredRooms.length === 0) {
                myRoomsContainer.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; opacity: 0.6;"><p>No rooms match your filters</p></div>';
            } else {
                myRoomsContainer.innerHTML = myFilteredRooms.map(room => renderRoomCard(room, true)).join('');
            }
            
            if (publicFilteredRooms.length === 0) {
                publicRoomsContainer.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; opacity: 0.6;"><p>No rooms match your filters</p></div>';
            } else {
                publicRoomsContainer.innerHTML = publicFilteredRooms.map(room => renderRoomCard(room, false)).join('');
            }
        }
        
        // WebRTC Functions
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let screenStream = null;
        
        async function initializeWebRTC() {
            try {
                // This is a simplified implementation
                // In production, you'd need a signaling server
                console.log('WebRTC initialized (demo mode)');
            } catch (error) {
                console.error('Failed to initialize WebRTC:', error);
                showToast('Failed to initialize media devices', 'error');
            }
        }
        
        async function toggleMicrophone() {
            const btn = document.getElementById('toggle-mic');
            if (!localStream) {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    btn.classList.add('active');
                    btn.style.background = 'var(--primary)';
                    showToast('Microphone enabled', 'success');
                } catch (error) {
                    showToast('Failed to access microphone', 'error');
                }
            } else {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = !track.enabled;
                    if (track.enabled) {
                        btn.classList.add('active');
                        btn.style.background = 'var(--primary)';
                        showToast('Microphone unmuted', 'success');
                    } else {
                        btn.classList.remove('active');
                        btn.style.background = '';
                        showToast('Microphone muted', 'info');
                    }
                });
            }
        }
        
        async function toggleCamera() {
            const btn = document.getElementById('toggle-camera');
            const localVideo = document.getElementById('local-video');
            const placeholder = document.getElementById('no-video-placeholder');
            
            if (!localStream || !localStream.getVideoTracks().length) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                    localStream = stream;
                    localVideo.srcObject = stream;
                    localVideo.style.display = 'block';
                    placeholder.style.display = 'none';
                    btn.classList.add('active');
                    btn.style.background = 'var(--primary)';
                    showToast('Camera enabled', 'success');
                } catch (error) {
                    showToast('Failed to access camera', 'error');
                }
            } else {
                localStream.getVideoTracks().forEach(track => {
                    track.enabled = !track.enabled;
                    if (track.enabled) {
                        localVideo.style.display = 'block';
                        placeholder.style.display = 'none';
                        btn.classList.add('active');
                        btn.style.background = 'var(--primary)';
                        showToast('Camera enabled', 'success');
                    } else {
                        localVideo.style.display = 'none';
                        placeholder.style.display = 'flex';
                        btn.classList.remove('active');
                        btn.style.background = '';
                        showToast('Camera disabled', 'info');
                    }
                });
            }
        }
        
        async function toggleScreenShare() {
            const btn = document.getElementById('toggle-screen');
            const screenShareDiv = document.getElementById('screen-share');
            const screenVideo = document.getElementById('screen-video');
            const localVideo = document.getElementById('local-video');
            const placeholder = document.getElementById('no-video-placeholder');
            
            if (!screenStream) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    screenVideo.srcObject = screenStream;
                    screenShareDiv.style.display = 'block';
                    localVideo.style.display = 'none';
                    placeholder.style.display = 'none';
                    btn.classList.add('active');
                    btn.style.background = 'var(--primary)';
                    btn.textContent = 'üõë Stop Sharing';
                    showToast('Screen sharing started', 'success');
                    
                    screenStream.getVideoTracks()[0].onended = () => {
                        stopScreenShare();
                    };
                } catch (error) {
                    showToast('Failed to share screen', 'error');
                }
            } else {
                stopScreenShare();
            }
        }
        
        function stopScreenShare() {
            const btn = document.getElementById('toggle-screen');
            const screenShareDiv = document.getElementById('screen-share');
            const placeholder = document.getElementById('no-video-placeholder');
            
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            screenShareDiv.style.display = 'none';
            placeholder.style.display = 'flex';
            btn.classList.remove('active');
            btn.style.background = '';
            btn.textContent = 'üñ•Ô∏è Share Screen';
            showToast('Screen sharing stopped', 'info');
        }
        
        function cleanupWebRTC() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
        }

        // ============================================
        // LESSONS FUNCTIONALITY
        // ============================================
        function showCreateLessonModal() {
            if (!APP_STATE.currentUser) {
                showAuthModal();
                return;
            }
            
            const modal = createModal('Create New Lesson', `
                <form onsubmit="createLesson(event)" style="font-size: 0.875rem;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Title *</label>
                            <input type="text" id="lesson-title" required maxlength="100" 
                                   placeholder="Lesson name"
                                   style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                          border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                          color: var(--text); font-size: 0.8rem;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Category *</label>
                            <select id="lesson-category" required
                                    style="width: 100%; padding: 0.4rem; background: #1e293b;
                                           border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                           color: var(--text); font-size: 0.8rem;">
                                <option value="fundamentals">üß† Basic</option>
                                <option value="intermediate">üìö Inter</option>
                                <option value="advanced">üéì Adv</option>
                                <option value="tutorial">üìñ Tutorial</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Description *</label>
                        <textarea id="lesson-description" required rows="2" maxlength="500"
                                  placeholder="What students will learn"
                                  style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                         border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                         color: var(--text); font-size: 0.8rem; resize: none;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Content *</label>
                        <textarea id="lesson-content" required rows="3" 
                                  placeholder="Lesson content..."
                                  style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                         border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                         color: var(--text); font-size: 0.8rem; resize: none;"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Difficulty</label>
                            <select id="lesson-difficulty"
                                    style="width: 100%; padding: 0.4rem; background: #1e293b;
                                           border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                           color: var(--text); font-size: 0.8rem;">
                                <option value="beginner">üü¢ Easy</option>
                                <option value="intermediate">üü° Med</option>
                                <option value="advanced">üî¥ Hard</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Duration</label>
                            <input type="number" id="lesson-duration" min="5" max="300" value="30"
                                   style="width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.05);
                                          border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem;
                                          color: var(--text); font-size: 0.8rem;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.8rem;">Files</label>
                            <input type="file" id="lesson-files" multiple style="display: none;" 
                                   onchange="handleFileSelect(event, 'lesson')">
                            <button type="button" class="btn btn-secondary" 
                                    onclick="document.getElementById('lesson-files').click()"
                                    style="width: 100%; padding: 0.4rem; font-size: 0.8rem;">
                                üìö Add
                            </button>
                        </div>
                    </div>
                    
                    <div id="lesson-files-preview" style="max-height: 60px; overflow-y: auto; margin-bottom: 0.75rem;"></div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">üìö Create</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" 
                                style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">Cancel</button>
                    </div>
                </form>
            `);
            
            // Adjust modal size
            modal.querySelector('.modal-content').style.maxWidth = '450px';
            modal.querySelector('.modal-content').style.maxHeight = 'fit-content';
        }
        
        async function createLesson(event) {
            event.preventDefault();
            
            const title = document.getElementById('lesson-title').value.trim();
            const category = document.getElementById('lesson-category').value;
            const description = document.getElementById('lesson-description').value.trim();
            const content = document.getElementById('lesson-content').innerHTML;
            const difficulty = document.getElementById('lesson-difficulty').value;
            const duration = document.getElementById('lesson-duration').value;
            
            if (!title || !description || !content) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            const lessonData = {
                title: sanitizeInput(title),
                category,
                description: sanitizeInput(description),
                content,
                difficulty,
                duration,
                files: uploadedFiles.lesson || [],
                author: APP_STATE.currentUser.username,
                authorId: APP_STATE.currentUser.id
            };
            
            // Try to create via API first
            let newLesson = await ApiService.createLesson(lessonData);
            
            // If API fails, create locally
            if (!newLesson) {
                newLesson = {
                    id: 'lesson_' + Date.now(),
                    ...lessonData,
                    created: new Date().toISOString(),
                    views: 0,
                    completions: 0
                };
                
                if (!APP_STATE.lessons) APP_STATE.lessons = [];
                APP_STATE.lessons.unshift(newLesson);
                saveAppData('lessons', APP_STATE.lessons);
            } else {
                // Update local state with API response
                if (!APP_STATE.lessons) APP_STATE.lessons = [];
                APP_STATE.lessons.unshift(newLesson);
            }
            
            // Clear uploaded files
            uploadedFiles.lesson = [];
            
            // Add to activity
            addActivityItem('project', `${APP_STATE.currentUser.username} created lesson "${title}"`);
            addNotification('project', `Your lesson "${title}" was created!`);
            
            closeModal();
            showToast('Lesson created successfully!', 'success');
            
            // Refresh lessons page if we're on it
            if (APP_STATE.currentPage === 'lessons') {
                renderLessons();
            }
        }
        
        function renderLessons() {
            // This would render the lessons on the lessons page
            const lessonsSection = document.querySelector('#lessons .grid');
            if (lessonsSection && APP_STATE.lessons) {
                const additionalLessons = APP_STATE.lessons.map(lesson => `
                    <div class="card">
                        <h3 style="color: var(--primary);">${lesson.title}</h3>
                        <p>${lesson.description}</p>
                        <div style="margin-top: 1rem;">
                            <span style="padding: 0.25rem 0.75rem; background: ${
                                lesson.difficulty === 'beginner' ? 'var(--success)' :
                                lesson.difficulty === 'intermediate' ? 'var(--warning)' : 'var(--danger)'
                            }; color: white; border-radius: 1rem; font-size: 0.875rem;">
                                ${lesson.difficulty.charAt(0).toUpperCase() + lesson.difficulty.slice(1)}
                            </span>
                            ${lesson.files && lesson.files.length > 0 ? `
                                <span style="margin-left: 0.5rem; padding: 0.25rem 0.75rem; background: var(--primary); 
                                       color: white; border-radius: 1rem; font-size: 0.875rem;">
                                    üìé ${lesson.files.length} files
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
                
                // Add to existing lessons
                lessonsSection.innerHTML += additionalLessons;
            }
        }

        // ============================================
        // FRIENDS AND MESSAGING SYSTEM
        // ============================================
        function loadFriendsPage() {
            if (!APP_STATE.currentUser) {
                showAuthModal();
                return;
            }
            
            renderFriendRequests();
            renderFriendsList();
            updateOnlineFriendsCount();
        }
        
        function searchUsers() {
            const searchInput = document.getElementById('user-search');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            if (!searchTerm) {
                document.getElementById('user-search-results').innerHTML = '';
                return;
            }
            
            // Simulate user search (in real app, would query backend)
            const mockUsers = [
                { id: 'user_1', username: 'Alice Dev', avatar: 'üë©‚Äçüíª', bio: 'AI researcher', online: true },
                { id: 'user_2', username: 'Bob Builder', avatar: 'üë∑', bio: 'Full stack developer', online: false },
                { id: 'user_3', username: 'Carol Charts', avatar: 'üìä', bio: 'Data scientist', online: true }
            ];
            
            const results = mockUsers.filter(u => 
                u.username.toLowerCase().includes(searchTerm) && 
                u.id !== APP_STATE.currentUser.id &&
                !APP_STATE.friends.has(u.id)
            );
            
            const resultsDiv = document.getElementById('user-search-results');
            resultsDiv.innerHTML = results.map(user => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; 
                            background: rgba(0,0,0,0.2); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <div class="user-avatar ${user.online ? 'online' : ''}">${user.avatar}</div>
                    <div style="flex: 1;">
                        <div style="color: var(--text); font-weight: 500;">${user.username}</div>
                        <div style="color: var(--text); opacity: 0.6; font-size: 0.875rem;">${user.bio}</div>
                    </div>
                    <button class="btn btn-primary" onclick="sendFriendRequest('${user.id}', '${user.username}')">
                        ‚ûï Add Friend
                    </button>
                </div>
            `).join('') || '<p style="color: var(--text); opacity: 0.6;">No users found</p>';
        }
        
        function sendFriendRequest(userId, username) {
            const request = {
                id: 'req_' + Date.now(),
                from: APP_STATE.currentUser.id,
                fromName: APP_STATE.currentUser.username,
                to: userId,
                toName: username,
                status: 'pending',
                created: new Date().toISOString()
            };
            
            APP_STATE.friendRequests.push(request);
            saveAppData('friendRequests', APP_STATE.friendRequests);
            
            showToast(`Friend request sent to ${username}!`, 'success');
            searchUsers(); // Refresh search results
            
            // Simulate receiving a friend request back (for demo)
            if (Math.random() > 0.5) {
                setTimeout(() => {
                    receiveFriendRequest(userId, username);
                }, 2000);
            }
        }
        
        function receiveFriendRequest(fromId, fromName) {
            const request = {
                id: 'req_' + Date.now(),
                from: fromId,
                fromName: fromName,
                to: APP_STATE.currentUser.id,
                toName: APP_STATE.currentUser.username,
                status: 'pending',
                created: new Date().toISOString()
            };
            
            APP_STATE.friendRequests.push(request);
            saveAppData('friendRequests', APP_STATE.friendRequests);
            
            addNotification('follow', `${fromName} sent you a friend request!`);
            renderFriendRequests();
        }
        
        function renderFriendRequests() {
            const requests = APP_STATE.friendRequests.filter(r => 
                r.to === APP_STATE.currentUser.id && r.status === 'pending'
            );
            
            const section = document.getElementById('friend-requests-section');
            const list = document.getElementById('friend-requests-list');
            
            if (requests.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = requests.map(req => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; 
                            background: rgba(0,0,0,0.2); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <div class="user-avatar">üë§</div>
                    <div style="flex: 1;">
                        <div style="color: var(--text);">${req.fromName} wants to be your friend</div>
                        <div style="color: var(--text); opacity: 0.6; font-size: 0.875rem;">
                            ${formatTime(req.created)}
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="acceptFriendRequest('${req.id}')">
                        ‚úÖ Accept
                    </button>
                    <button class="btn btn-secondary" onclick="declineFriendRequest('${req.id}')">
                        ‚ùå Decline
                    </button>
                </div>
            `).join('');
        }
        
        function acceptFriendRequest(requestId) {
            const request = APP_STATE.friendRequests.find(r => r.id === requestId);
            if (!request) return;
            
            // Add as friend
            const friend = {
                id: request.from,
                username: request.fromName,
                avatar: 'üë§',
                addedAt: new Date().toISOString(),
                online: Math.random() > 0.5
            };
            
            APP_STATE.friends.set(friend.id, friend);
            
            // Update request status
            request.status = 'accepted';
            
            saveAppData('friends', Array.from(APP_STATE.friends.entries()));
            saveAppData('friendRequests', APP_STATE.friendRequests);
            
            showToast(`You and ${friend.username} are now friends!`, 'success');
            renderFriendRequests();
            renderFriendsList();
            
            // Create initial conversation
            createConversation(friend.id, friend.username);
        }
        
        function declineFriendRequest(requestId) {
            const request = APP_STATE.friendRequests.find(r => r.id === requestId);
            if (request) {
                request.status = 'declined';
                saveAppData('friendRequests', APP_STATE.friendRequests);
                renderFriendRequests();
                showToast('Friend request declined', 'info');
            }
        }
        
        function renderFriendsList() {
            const list = document.getElementById('friends-list');
            
            if (APP_STATE.friends.size === 0) {
                list.innerHTML = '<p style="color: var(--text); opacity: 0.6;">No friends yet. Search for users to add!</p>';
                return;
            }
            
            list.innerHTML = Array.from(APP_STATE.friends.values()).map(friend => `
                <div class="card" style="display: flex; align-items: center; gap: 1rem;">
                    <div class="user-avatar ${friend.online ? 'online' : ''}">${friend.avatar}</div>
                    <div style="flex: 1;">
                        <div style="color: var(--text); font-weight: 500;">${friend.username}</div>
                        <div style="color: ${friend.online ? 'var(--success)' : 'var(--text)'}; 
                                    opacity: 0.8; font-size: 0.875rem;">
                            ${friend.online ? 'üü¢ Online' : '‚≠ï Offline'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" style="padding: 0.5rem;" 
                                onclick="viewUserProfile('${friend.id}')">
                            üë§ Profile
                        </button>
                        <button class="btn btn-primary" style="padding: 0.5rem;" 
                                onclick="openChat('${friend.id}')">
                            üí¨ Message
                        </button>
                        <button class="btn" style="padding: 0.5rem; background: var(--danger); color: white;" 
                                onclick="removeFriend('${friend.id}')">
                            ‚ùå
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function updateOnlineFriendsCount() {
            const onlineCount = Array.from(APP_STATE.friends.values()).filter(f => f.online).length;
            document.getElementById('friends-online-count').textContent = `${onlineCount} online`;
        }
        
        function removeFriend(friendId) {
            const friend = APP_STATE.friends.get(friendId);
            if (friend && confirm(`Remove ${friend.username} from friends?`)) {
                APP_STATE.friends.delete(friendId);
                saveAppData('friends', Array.from(APP_STATE.friends.entries()));
                renderFriendsList();
                showToast('Friend removed', 'info');
            }
        }
        
        // Messaging System
        function loadMessagesPage() {
            if (!APP_STATE.currentUser) {
                showAuthModal();
                return;
            }
            
            renderConversationsList();
        }
        
        function createConversation(userId, username) {
            const conversation = {
                id: 'conv_' + Date.now(),
                type: 'direct',
                participants: [APP_STATE.currentUser.id, userId],
                participantNames: [APP_STATE.currentUser.username, username],
                lastMessage: null,
                lastActivity: new Date().toISOString()
            };
            
            // Check if conversation already exists
            const existing = APP_STATE.messages.find(c => 
                c.type === 'direct' && 
                c.participants.includes(userId) && 
                c.participants.includes(APP_STATE.currentUser.id)
            );
            
            if (!existing) {
                APP_STATE.messages.push(conversation);
                saveAppData('messages', APP_STATE.messages);
            }
        }
        
        function renderConversationsList() {
            const list = document.getElementById('conversations-list');
            
            if (APP_STATE.messages.length === 0) {
                list.innerHTML = '<p style="color: var(--text); opacity: 0.6; padding: 1rem;">No conversations yet</p>';
                return;
            }
            
            list.innerHTML = APP_STATE.messages.map(conv => {
                const otherUser = conv.participantNames.find(name => name !== APP_STATE.currentUser.username);
                const isGroup = conv.type === 'group';
                
                return `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; 
                                background: rgba(0,0,0,0.2); border-radius: 0.5rem; margin-bottom: 0.5rem;
                                cursor: pointer;" onclick="selectConversation('${conv.id}')">
                        <div class="user-avatar">${isGroup ? 'üë•' : 'üë§'}</div>
                        <div style="flex: 1;">
                            <div style="color: var(--text); font-weight: 500;">
                                ${isGroup ? conv.name : otherUser}
                            </div>
                            ${conv.lastMessage ? `
                                <div style="color: var(--text); opacity: 0.6; font-size: 0.875rem;">
                                    ${conv.lastMessage}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        let currentConversation = null;
        
        function selectConversation(convId) {
            currentConversation = APP_STATE.messages.find(c => c.id === convId);
            if (!currentConversation) return;
            
            const header = document.getElementById('chat-header');
            const messagesDiv = document.getElementById('chat-messages');
            const inputArea = document.getElementById('chat-input-area');
            
            const otherUser = currentConversation.participantNames.find(name => name !== APP_STATE.currentUser.username);
            header.innerHTML = `<h3 style="color: var(--text);">üí¨ ${currentConversation.type === 'group' ? currentConversation.name : otherUser}</h3>`;
            
            // Load messages
            if (!currentConversation.messages) currentConversation.messages = [];
            
            messagesDiv.innerHTML = currentConversation.messages.map(msg => `
                <div style="margin-bottom: 1rem; ${msg.from === APP_STATE.currentUser.id ? 'text-align: right;' : ''}">
                    <div style="display: inline-block; max-width: 70%; padding: 0.75rem; 
                                background: ${msg.from === APP_STATE.currentUser.id ? 'var(--primary)' : 'rgba(0,0,0,0.3)'}; 
                                color: white; border-radius: 1rem;">
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">${msg.fromName}</div>
                        <div>${msg.text}</div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem;">
                            ${formatTime(msg.timestamp)}
                        </div>
                    </div>
                </div>
            `).join('') || '<p style="text-align: center; color: var(--text); opacity: 0.6;">No messages yet. Start the conversation!</p>';
            
            inputArea.style.display = 'block';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function sendMessage() {
            if (!currentConversation) return;
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            const message = {
                id: 'msg_' + Date.now(),
                from: APP_STATE.currentUser.id,
                fromName: APP_STATE.currentUser.username,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            if (!currentConversation.messages) currentConversation.messages = [];
            currentConversation.messages.push(message);
            currentConversation.lastMessage = text;
            currentConversation.lastActivity = message.timestamp;
            
            saveAppData('messages', APP_STATE.messages);
            
            input.value = '';
            selectConversation(currentConversation.id); // Refresh display
            
            // Simulate reply (for demo)
            if (currentConversation.type === 'direct' && Math.random() > 0.5) {
                setTimeout(() => {
                    const reply = {
                        id: 'msg_' + Date.now(),
                        from: currentConversation.participants.find(p => p !== APP_STATE.currentUser.id),
                        fromName: currentConversation.participantNames.find(n => n !== APP_STATE.currentUser.username),
                        text: 'Thanks for your message! üëç',
                        timestamp: new Date().toISOString()
                    };
                    currentConversation.messages.push(reply);
                    saveAppData('messages', APP_STATE.messages);
                    selectConversation(currentConversation.id);
                }, 1500);
            }
        }
        
        function openChat(userId) {
            const friend = APP_STATE.friends.get(userId);
            if (!friend) return;
            
            // Find or create conversation
            let conversation = APP_STATE.messages.find(c => 
                c.type === 'direct' && 
                c.participants.includes(userId) && 
                c.participants.includes(APP_STATE.currentUser.id)
            );
            
            if (!conversation) {
                createConversation(userId, friend.username);
                conversation = APP_STATE.messages[APP_STATE.messages.length - 1];
            }
            
            navigateTo('messages');
            setTimeout(() => selectConversation(conversation.id), 100);
        }
        
        function createGroupChat() {
            const modal = createModal('Create Group Chat', `
                <form onsubmit="createGroup(event)">
                    <div class="form-group">
                        <label>Group Name *</label>
                        <input type="text" id="group-name" required placeholder="e.g., AI Study Group">
                    </div>
                    
                    <div class="form-group">
                        <label>Select Friends to Add</label>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); 
                                    border-radius: 0.5rem; padding: 0.5rem;">
                            ${Array.from(APP_STATE.friends.values()).map(friend => `
                                <label style="display: block; padding: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" value="${friend.id}" name="group-members">
                                    <span style="margin-left: 0.5rem;">${friend.username}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary">Create Group</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }
        
        function createGroup(event) {
            event.preventDefault();
            
            const name = document.getElementById('group-name').value;
            const checkboxes = document.querySelectorAll('input[name="group-members"]:checked');
            const members = Array.from(checkboxes).map(cb => cb.value);
            
            if (members.length === 0) {
                showToast('Please select at least one friend', 'error');
                return;
            }
            
            members.push(APP_STATE.currentUser.id); // Add current user
            
            const group = {
                id: 'group_' + Date.now(),
                type: 'group',
                name: name,
                participants: members,
                participantNames: [APP_STATE.currentUser.username, ...Array.from(checkboxes).map(cb => {
                    const friend = APP_STATE.friends.get(cb.value);
                    return friend ? friend.username : '';
                })],
                messages: [],
                lastMessage: null,
                lastActivity: new Date().toISOString(),
                createdBy: APP_STATE.currentUser.id
            };
            
            APP_STATE.messages.push(group);
            APP_STATE.groupChats.push(group);
            saveAppData('messages', APP_STATE.messages);
            saveAppData('groupChats', APP_STATE.groupChats);
            
            closeModal();
            renderConversationsList();
            showToast(`Group "${name}" created!`, 'success');
        }
        
        function updateMessageBadge() {
            // Count unread messages (simplified - in real app would track read status)
            const unread = APP_STATE.messages.filter(c => c.lastMessage).length;
            // You can add a badge to the messages nav button if needed
        }
        
        function viewUserProfile(userId) {
            // If viewing own profile
            if (userId === APP_STATE.currentUser?.id) {
                navigateTo('profile');
                return;
            }
            
            // Get friend info
            const friend = APP_STATE.friends.get(userId);
            if (!friend) {
                // Try to find in mock users for demo
                const mockUser = {
                    id: userId,
                    username: 'User',
                    avatar: 'üë§',
                    online: false
                };
                friend = mockUser;
            }
            
            // Get user's projects
            const userProjects = APP_STATE.projects.filter(p => p.authorId === userId);
            
            const modal = createModal(`${friend.username}'s Profile`, `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div class="user-avatar ${friend.online ? 'online' : ''}" style="width: 100px; height: 100px; 
                                font-size: 3rem; margin: 0 auto 1rem;">
                        ${friend.avatar || 'üë§'}
                    </div>
                    <h2 style="color: var(--text); margin-bottom: 0.5rem;">${friend.username}</h2>
                    <p style="color: ${friend.online ? 'var(--success)' : 'var(--text)'}; opacity: 0.8;">
                        ${friend.online ? 'üü¢ Online' : '‚≠ï Offline'}
                    </p>
                </div>
                
                <div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 2rem; 
                            padding: 1rem 0; border-top: 1px solid rgba(255,255,255,0.1); 
                            border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">
                            ${userProjects.length}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Projects</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">
                            ${Math.floor(Math.random() * 50) + 10}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Friends</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">
                            ${userProjects.reduce((sum, p) => sum + p.likes, 0)}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text); opacity: 0.8;">Total Likes</div>
                    </div>
                </div>
                
                <h3 style="color: var(--primary); margin-bottom: 1rem;">üìÅ ${friend.username}'s Projects</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${userProjects.length === 0 ? '<p style="color: var(--text); opacity: 0.6;">No projects yet</p>' : ''}
                    ${userProjects.map(project => `
                        <div class="card" style="margin-bottom: 1rem;">
                            <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${project.title}</h4>
                            <p style="margin-bottom: 1rem;">${project.description}</p>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                ${project.tech.slice(0, 3).map(t => `
                                    <span style="padding: 0.25rem 0.5rem; background: rgba(124,58,237,0.2); 
                                           color: var(--primary); border-radius: 0.25rem; font-size: 0.75rem;">
                                        ${t}
                                    </span>
                                `).join('')}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; gap: 1rem; font-size: 0.875rem;">
                                    <span>‚ù§Ô∏è ${project.likes}</span>
                                    <span>‚≠ê ${project.stars}</span>
                                    <span>üí¨ ${project.comments ? project.comments.length : 0}</span>
                                </div>
                                <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" 
                                        onclick="closeModal(); viewProject('${project.id}');">
                                    View Project ‚Üí
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="openChat('${friend.id}')">
                        üí¨ Send Message
                    </button>
                    ${!APP_STATE.friends.has(friend.id) ? `
                        <button class="btn btn-secondary" style="flex: 1;" 
                                onclick="sendFriendRequest('${friend.id}', '${friend.username}')">
                            ‚ûï Add Friend
                        </button>
                    ` : ''}
                </div>
            `);
        }
        
        function deleteProject(projectId) {
            const project = APP_STATE.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Check permissions - only owner can delete
            if (project.authorId !== APP_STATE.currentUser?.id) {
                showToast('You can only delete your own projects', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to delete "${project.title}"? This cannot be undone.`)) {
                APP_STATE.projects = APP_STATE.projects.filter(p => p.id !== projectId);
                saveAppData('projects', APP_STATE.projects);
                
                closeModal();
                renderProjects();
                showToast('Project deleted successfully', 'success');
            }
        }
        
        function editProject(projectId) {
            const project = APP_STATE.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Check permissions - only owner can edit
            if (project.authorId !== APP_STATE.currentUser?.id) {
                showToast('You can only edit your own projects', 'error');
                return;
            }
            
            // Show edit modal (simplified - in real app would have full edit form)
            showToast('Edit functionality coming soon!', 'info');
        }

        // ============================================
        // MESSAGES WIDGET FUNCTIONALITY
        // ============================================
        function toggleMessagesWidget() {
            const minimized = document.getElementById('messages-widget-minimized');
            const expanded = document.getElementById('messages-widget-expanded');
            
            if (minimized.style.display === 'none') {
                minimized.style.display = 'block';
                expanded.style.display = 'none';
            } else {
                minimized.style.display = 'none';
                expanded.style.display = 'block';
                loadWidgetConversations();
            }
        }
        
        function loadWidgetConversations() {
            const widgetConv = document.getElementById('widget-conversations');
            if (!widgetConv) return;
            
            if (APP_STATE.messages.length === 0) {
                widgetConv.innerHTML = '<p style="padding: 0.5rem; color: var(--text); opacity: 0.6; font-size: 0.75rem;">No chats</p>';
                return;
            }
            
            widgetConv.innerHTML = APP_STATE.messages.map(conv => {
                const otherUser = conv.participantNames.find(name => name !== APP_STATE.currentUser?.username);
                const isGroup = conv.type === 'group';
                
                return `
                    <div style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1);" 
                         onclick="selectWidgetConversation('${conv.id}')"
                         onmouseover="this.style.background='rgba(124,58,237,0.2)'"
                         onmouseout="this.style.background='transparent'">
                        <div style="font-size: 1.5rem; text-align: center;">${isGroup ? 'üë•' : 'üë§'}</div>
                        <div style="font-size: 0.75rem; text-align: center; color: var(--text); margin-top: 0.25rem;">
                            ${isGroup ? conv.name : otherUser}
                        </div>
                    </div>
                `;
            }).join('');
            
            updateMessagesBadge();
        }
        
        let currentWidgetConversation = null;
        
        function selectWidgetConversation(convId) {
            currentWidgetConversation = APP_STATE.messages.find(c => c.id === convId);
            if (!currentWidgetConversation) return;
            
            const messagesDiv = document.getElementById('widget-chat-messages');
            const inputDiv = document.getElementById('widget-chat-input');
            
            if (!currentWidgetConversation.messages) currentWidgetConversation.messages = [];
            
            messagesDiv.innerHTML = currentWidgetConversation.messages.map(msg => `
                <div style="margin-bottom: 0.5rem; ${msg.from === APP_STATE.currentUser?.id ? 'text-align: right;' : ''}">
                    <div style="display: inline-block; max-width: 80%; padding: 0.5rem; 
                                background: ${msg.from === APP_STATE.currentUser?.id ? 'var(--primary)' : 'rgba(0,0,0,0.3)'}; 
                                color: white; border-radius: 0.75rem; font-size: 0.875rem;">
                        <div style="font-weight: 500; font-size: 0.75rem; margin-bottom: 0.25rem;">${msg.fromName}</div>
                        <div>${msg.text}</div>
                    </div>
                </div>
            `).join('') || '<p style="text-align: center; color: var(--text); opacity: 0.6; font-size: 0.875rem;">No messages yet</p>';
            
            inputDiv.style.display = 'block';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function sendWidgetMessage() {
            if (!currentWidgetConversation) return;
            
            const input = document.getElementById('widget-message-input');
            const text = input.value.trim();
            
            if (!text) return;
            
            const message = {
                id: 'msg_' + Date.now(),
                from: APP_STATE.currentUser.id,
                fromName: APP_STATE.currentUser.username,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            if (!currentWidgetConversation.messages) currentWidgetConversation.messages = [];
            currentWidgetConversation.messages.push(message);
            currentWidgetConversation.lastMessage = text;
            currentWidgetConversation.lastActivity = message.timestamp;
            
            saveAppData('messages', APP_STATE.messages);
            
            input.value = '';
            selectWidgetConversation(currentWidgetConversation.id);
        }
        
        function updateMessagesBadge() {
            const badge = document.getElementById('messages-badge');
            const unreadCount = APP_STATE.messages.filter(c => c.lastMessage).length;
            
            if (unreadCount > 0 && badge) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.style.display = 'flex';
            } else if (badge) {
                badge.style.display = 'none';
            }
        }

        // ============================================
        // FILE DOWNLOAD AND PREVIEW FUNCTIONS
        // ============================================
        function downloadProjectFile(projectId, fileName) {
            const project = APP_STATE.projects.find(p => p.id === projectId);
            if (!project || !project.files) return;
            
            const file = project.files.find(f => f.name === fileName);
            if (!file) return;
            
            // If it's an image with dataUrl, create download link
            if (file.dataUrl) {
                const a = document.createElement('a');
                a.href = file.dataUrl;
                a.download = file.name;
                a.click();
            } else {
                // For other files, show notification (in real app, would download from server)
                showToast(`Downloading ${file.name}...`, 'info');
            }
        }

        // ============================================
        // CALENDAR FUNCTIONALITY
        // ============================================
        function showCalendar() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const currentDate = today.getDate();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let calendarHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; text-align: center;">
                        ${monthNames[currentMonth]} ${currentYear}
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="text-align: center; font-weight: bold; color: var(--primary);">Sun</div>
                        <div style="text-align: center; font-weight: bold; color: var(--primary);">Mon</div>
                        <div style="text-align: center; font-weight: bold; color: var(--primary);">Tue</div>
                        <div style="text-align: center; font-weight: bold; color: var(--primary);">Wed</div>
                        <div style="text-align: center; font-weight: bold; color: var(--primary);">Thu</div>
                        <div style="text-align: center; font-weight: bold; color: var(--primary);">Fri</div>
                        <div style="text-align: center; font-weight: bold; color: var(--primary);">Sat</div>
            `;
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div></div>';
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === currentDate;
                calendarHTML += `
                    <div style="text-align: center; padding: 0.5rem; border-radius: 0.25rem; 
                                background: ${isToday ? 'var(--primary)' : 'rgba(124, 58, 237, 0.1)'};
                                color: ${isToday ? 'white' : 'var(--text)'};
                                cursor: pointer;"
                         onmouseover="if(${!isToday}) this.style.background='rgba(124, 58, 237, 0.3)'"
                         onmouseout="if(${!isToday}) this.style.background='rgba(124, 58, 237, 0.1)'"
                         onclick="showDayEvents(${day}, ${currentMonth}, ${currentYear})">
                        ${day}
                    </div>
                `;
            }
            
            calendarHTML += `
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Upcoming Events</h4>
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 1rem; border-radius: 0.5rem;">
                        <p style="color: var(--text); opacity: 0.8;">No events scheduled</p>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-primary" onclick="addCalendarEvent()" style="width: 100%;">
                        ‚ûï Add Event
                    </button>
                </div>
            `;
            
            createModal('üìÖ Calendar', calendarHTML);
        }
        
        function showDayEvents(day, month, year) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            const dateStr = `${monthNames[month]} ${day}, ${year}`;
            
            const eventHTML = `
                <form onsubmit="saveCalendarEvent(event, ${day}, ${month}, ${year})">
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--primary); margin-bottom: 0.5rem;">üìÖ ${dateStr}</h4>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Event Type</label>
                            <select id="event-type" style="width: 100%; padding: 0.5rem; background: rgba(0, 0, 0, 0.3);
                                           border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 0.25rem;
                                           color: var(--text); font-size: 0.875rem;">
                                <option value="todo">üìù To-Do</option>
                                <option value="deadline">‚è∞ Deadline</option>
                                <option value="meeting">üë• Meeting</option>
                                <option value="reminder">üîî Reminder</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Time</label>
                            <input type="time" id="event-time" 
                                   style="width: 100%; padding: 0.5rem; background: rgba(0, 0, 0, 0.3);
                                          border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 0.25rem;
                                          color: var(--text); font-size: 0.875rem;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Title *</label>
                        <input type="text" id="event-title" required maxlength="100"
                               placeholder="Enter event title..."
                               style="width: 100%; padding: 0.5rem; background: rgba(0, 0, 0, 0.3);
                                      border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 0.25rem;
                                      color: var(--text); font-size: 0.875rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">Description</label>
                        <textarea id="event-description" rows="2" maxlength="200"
                                  placeholder="Add notes or details..."
                                  style="width: 100%; padding: 0.5rem; background: rgba(0, 0, 0, 0.3);
                                         border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 0.25rem;
                                         color: var(--text); font-size: 0.875rem; resize: none;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.5rem;">‚úÖ Save</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" 
                                style="flex: 1; padding: 0.5rem;">Cancel</button>
                    </div>
                </form>
            `;
            
            const modal = createModal('üìÜ Add Event', eventHTML);
            modal.querySelector('.modal-content').style.maxWidth = '400px';
            modal.querySelector('.modal-content').style.maxHeight = 'fit-content';
        }
        
        function saveCalendarEvent(event, day, month, year) {
            event.preventDefault();
            
            const eventType = document.getElementById('event-type').value;
            const eventTime = document.getElementById('event-time').value;
            const eventTitle = document.getElementById('event-title').value;
            const eventDescription = document.getElementById('event-description').value;
            
            // Save event to localStorage or app state
            const calendarEvent = {
                id: 'event_' + Date.now(),
                date: new Date(year, month, day),
                type: eventType,
                time: eventTime,
                title: eventTitle,
                description: eventDescription
            };
            
            // Store events in app state
            if (!APP_STATE.calendarEvents) APP_STATE.calendarEvents = [];
            APP_STATE.calendarEvents.push(calendarEvent);
            saveAppData('calendarEvents', APP_STATE.calendarEvents);
            
            closeModal();
            showToast(`Event "${eventTitle}" added for ${month + 1}/${day}/${year}`, 'success');
        }
        
        function addCalendarEvent() {
            const today = new Date();
            showDayEvents(today.getDate(), today.getMonth(), today.getFullYear());
        }

        // ============================================
        // LEARNING RESOURCES FUNCTIONALITY
        // ============================================
        function showResourceLibrary() {
            const resources = [
                { title: 'Introduction to Machine Learning', type: 'PDF', size: '2.3 MB', topic: 'ML Basics' },
                { title: 'Neural Networks Explained', type: 'Video', duration: '45 min', topic: 'Deep Learning' },
                { title: 'Python for Data Science', type: 'Interactive', level: 'Beginner', topic: 'Python' },
                { title: 'Advanced TensorFlow Techniques', type: 'Tutorial', level: 'Advanced', topic: 'TensorFlow' },
                { title: 'Computer Vision Fundamentals', type: 'Course', duration: '6 hours', topic: 'Computer Vision' },
                { title: 'NLP with Transformers', type: 'Workshop', level: 'Intermediate', topic: 'NLP' }
            ];
            
            const resourceHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <input type="text" placeholder="Search resources..." 
                           style="width: 100%; padding: 0.75rem; background: rgba(0, 0, 0, 0.3);
                                  border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 0.5rem;
                                  color: var(--text); font-size: 1rem;"
                           oninput="filterResources(this.value)">
                </div>
                
                <div id="resource-list" style="max-height: 400px; overflow-y: auto;">
                    ${resources.map(resource => `
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 1rem; border-radius: 0.5rem;
                                    margin-bottom: 1rem; cursor: pointer;"
                             onmouseover="this.style.background='rgba(124, 58, 237, 0.2)'"
                             onmouseout="this.style.background='rgba(0, 0, 0, 0.2)'"
                             onclick="openResource('${resource.title}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${resource.title}</h4>
                                    <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text); opacity: 0.8;">
                                        <span>üìÅ ${resource.type}</span>
                                        ${resource.duration ? `<span>‚è±Ô∏è ${resource.duration}</span>` : ''}
                                        ${resource.size ? `<span>üíæ ${resource.size}</span>` : ''}
                                        ${resource.level ? `<span>üìä ${resource.level}</span>` : ''}
                                    </div>
                                </div>
                                <span style="background: var(--primary); padding: 0.25rem 0.5rem;
                                           border-radius: 0.25rem; font-size: 0.75rem;">
                                    ${resource.topic}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            createModal('üìö Resource Library', resourceHTML);
        }
        
        function showVideoTutorials() {
            const videos = [
                { title: 'Getting Started with AI', thumbnail: 'üé•', duration: '15:30', views: '1.2K' },
                { title: 'Building Your First Neural Network', thumbnail: 'üé¨', duration: '28:45', views: '856' },
                { title: 'Data Preprocessing Techniques', thumbnail: 'üìπ', duration: '22:10', views: '623' },
                { title: 'Model Optimization Strategies', thumbnail: 'üéûÔ∏è', duration: '35:20', views: '445' },
                { title: 'Deploying ML Models', thumbnail: 'üé¶', duration: '41:15', views: '789' }
            ];
            
            const videoHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                            gap: 1.5rem;">
                    ${videos.map(video => `
                        <div style="background: rgba(0, 0, 0, 0.2); border-radius: 0.5rem; overflow: hidden;
                                    cursor: pointer;"
                             onmouseover="this.style.transform='scale(1.05)'"
                             onmouseout="this.style.transform='scale(1)'"
                             onclick="playVideo('${video.title}')"
                             style="transition: transform 0.3s ease;">
                            <div style="height: 150px; display: flex; align-items: center; justify-content: center;
                                        background: linear-gradient(135deg, rgba(124, 58, 237, 0.3), rgba(124, 58, 237, 0.1));
                                        font-size: 3rem;">
                                ${video.thumbnail}
                            </div>
                            <div style="padding: 1rem;">
                                <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${video.title}</h4>
                                <div style="display: flex; justify-content: space-between; font-size: 0.875rem;
                                            color: var(--text); opacity: 0.8;">
                                    <span>‚è±Ô∏è ${video.duration}</span>
                                    <span>üëÅÔ∏è ${video.views} views</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            createModal('üé• Video Tutorials', videoHTML);
        }
        
        function showCodeExamples() {
            const examples = [
                { title: 'Linear Regression', language: 'Python', difficulty: 'Beginner', lines: 45 },
                { title: 'CNN Image Classifier', language: 'Python', difficulty: 'Intermediate', lines: 128 },
                { title: 'RNN Text Generator', language: 'Python', difficulty: 'Advanced', lines: 256 },
                { title: 'Data Visualization', language: 'JavaScript', difficulty: 'Beginner', lines: 67 },
                { title: 'REST API for ML Model', language: 'Python', difficulty: 'Intermediate', lines: 189 }
            ];
            
            const codeHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem;">
                        <select style="flex: 1; padding: 0.75rem; background: rgba(0, 0, 0, 0.3);
                                       border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 0.5rem;
                                       color: var(--text);">
                            <option>All Languages</option>
                            <option>Python</option>
                            <option>JavaScript</option>
                            <option>Java</option>
                            <option>R</option>
                        </select>
                        <select style="flex: 1; padding: 0.75rem; background: rgba(0, 0, 0, 0.3);
                                       border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 0.5rem;
                                       color: var(--text);">
                            <option>All Difficulties</option>
                            <option>Beginner</option>
                            <option>Intermediate</option>
                            <option>Advanced</option>
                        </select>
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    ${examples.map(example => `
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 1rem; border-radius: 0.5rem;
                                    margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;
                                        margin-bottom: 0.5rem;">
                                <h4 style="color: var(--primary);">${example.title}</h4>
                                <span style="background: ${example.difficulty === 'Beginner' ? '#10b981' : 
                                           example.difficulty === 'Intermediate' ? '#f59e0b' : '#ef4444'};
                                           padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                    ${example.difficulty}
                                </span>
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text); opacity: 0.8;
                                        margin-bottom: 0.75rem;">
                                <span>üíª ${example.language}</span>
                                <span>üìù ${example.lines} lines</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" onclick="viewCode('${example.title}')"
                                        style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    View Code
                                </button>
                                <button class="btn btn-secondary" onclick="copyCode('${example.title}')"
                                        style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    Copy
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            createModal('üíª Code Examples', codeHTML);
        }
        
        function showExternalResources() {
            const resources = [
                { name: 'TensorFlow Documentation', url: 'tensorflow.org', category: 'Framework' },
                { name: 'PyTorch Tutorials', url: 'pytorch.org', category: 'Framework' },
                { name: 'Kaggle Datasets', url: 'kaggle.com', category: 'Data' },
                { name: 'Papers with Code', url: 'paperswithcode.com', category: 'Research' },
                { name: 'Google Colab', url: 'colab.research.google.com', category: 'Tools' },
                { name: 'Hugging Face', url: 'huggingface.co', category: 'Models' }
            ];
            
            const externalHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--text); opacity: 0.8;">
                        Curated list of external resources to enhance your learning journey.
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                            gap: 1rem;">
                    ${resources.map(resource => `
                        <div style="background: rgba(0, 0, 0, 0.2); padding: 1rem; border-radius: 0.5rem;
                                    text-align: center; cursor: pointer;"
                             onmouseover="this.style.background='rgba(124, 58, 237, 0.2)'"
                             onmouseout="this.style.background='rgba(0, 0, 0, 0.2)'"
                             onclick="window.open('https://${resource.url}', '_blank')">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîó</div>
                            <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${resource.name}</h4>
                            <span style="background: rgba(124, 58, 237, 0.3); padding: 0.25rem 0.5rem;
                                       border-radius: 0.25rem; font-size: 0.75rem;">
                                ${resource.category}
                            </span>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="btn btn-secondary" onclick="suggestResource()"
                            style="padding: 0.75rem 1.5rem;">
                        üí° Suggest a Resource
                    </button>
                </div>
            `;
            
            createModal('üåê External Resources', externalHTML);
        }
        
        function openResource(title) {
            showToast(`Opening: ${title}`, 'info');
        }
        
        function filterResources(query) {
            showToast(`Filtering resources: ${query}`, 'info');
        }
        
        function playVideo(title) {
            showToast(`Playing: ${title}`, 'info');
        }
        
        function viewCode(title) {
            showToast(`Viewing code: ${title}`, 'info');
        }
        
        function copyCode(title) {
            showToast(`Code copied: ${title}`, 'success');
        }
        
        function suggestResource() {
            showToast('Resource suggestion form coming soon!', 'info');
        }
        
        function viewFullImage(dataUrl, fileName) {
            const modal = createModal(fileName, `
                <div style="text-align: center;">
                    <img src="${dataUrl}" style="max-width: 100%; max-height: 70vh; border-radius: 0.5rem;">
                </div>
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn btn-primary" onclick="downloadImage('${dataUrl}', '${fileName}')">
                        ‚¨áÔ∏è Download Image
                    </button>
                </div>
            `);
        }
        
        function downloadImage(dataUrl, fileName) {
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = fileName;
            a.click();
            showToast('Image downloaded!', 'success');
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + K: Quick search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('project-search')?.focus();
            }
            
            // Escape: Close modal
            if (e.key === 'Escape') {
                closeModal();
            }
            
            // Alt + T: Toggle theme
            if (e.altKey && e.key === 't') {
                e.preventDefault();
                toggleTheme();
            }
        });
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        // Initialize search functionality
        function initializeSearch() {
            // Projects search - use direct oninput handlers already in HTML
            const projectSearch = document.getElementById('project-search');
            if (projectSearch) {
                // Trigger initial filter to show all projects
                filterProjects();
            }
            
            // Friends search
            const userSearch = document.getElementById('user-search');
            if (userSearch) {
                userSearch.removeEventListener('input', searchUsers);
                userSearch.removeEventListener('keyup', searchUsers);
                userSearch.addEventListener('input', searchUsers);
                userSearch.addEventListener('keyup', searchUsers);
            }
            
            // Room search
            const roomSearch = document.getElementById('room-search');
            if (roomSearch) {
                roomSearch.removeEventListener('input', filterRooms);
                roomSearch.removeEventListener('keyup', filterRooms);
                roomSearch.addEventListener('input', filterRooms);
                roomSearch.addEventListener('keyup', filterRooms);
            }
            
            // Category and sort filters are already handled via onchange in HTML
        }
        
        // Global search handler that works for all searches
        function handleSearch(searchType) {
            switch(searchType) {
                case 'projects':
                    filterProjects();
                    break;
                case 'users':
                    searchUsers();
                    break;
                case 'rooms':
                    filterRooms();
                    break;
            }
        }
        
        // Ensure all search inputs work
        function ensureSearchFunctionality() {
            // Projects search
            const projectSearch = document.getElementById('project-search');
            if (projectSearch) {
                console.log('Initializing project search');
                // Clear any inline handlers first
                projectSearch.oninput = null;
                projectSearch.onkeyup = null;
                // Add event listeners
                projectSearch.addEventListener('input', (e) => {
                    console.log('Project search input:', e.target.value);
                    filterProjects();
                });
            }
            
            // Friends/Users search  
            const userSearch = document.getElementById('user-search');
            if (userSearch) {
                console.log('Initializing user search');
                userSearch.addEventListener('input', (e) => {
                    console.log('User search input:', e.target.value);
                    searchUsers();
                });
            }
            
            // Rooms search
            const roomSearch = document.getElementById('room-search');
            if (roomSearch) {
                console.log('Initializing room search');
                roomSearch.oninput = null;
                roomSearch.addEventListener('input', (e) => {
                    console.log('Room search input:', e.target.value);
                    filterRooms();
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme
            initTheme();
            
            // Load saved data
            loadAppData();
            
            // Initialize mobile menu
            initMobileMenu();
            
            // Initialize search functionality
            initializeSearch();
            
            // Update auth button
            updateAuthButton();
            
            // Initialize sample data if needed
            if (APP_STATE.projects.length === 0) {
                loadSampleProjects();
            }
            
            // Navigate to home page
            navigateTo('home');
            
            // Update activity feed
            updateActivityFeed();
            
            // Ensure search works on initial load
            setTimeout(() => {
                ensureSearchFunctionality();
            }, 100);
            
            // Initialize keyboard shortcuts
            initKeyboardShortcuts();
            
            // Check achievements periodically
            setInterval(checkAchievements, 30000);
            checkAchievements();
            
            // Add back to top button
            addBackToTopButton();
            
            // Initialize lazy loading
            initLazyLoading();
            
            // Load saved accessibility settings
            const savedFontSize = localStorage.getItem('aiHub_fontSize');
            if (savedFontSize) {
                document.documentElement.style.setProperty('--font-size', savedFontSize + 'px');
                document.body.style.fontSize = savedFontSize + 'px';
            }
            
            const savedHighContrast = localStorage.getItem('aiHub_highContrast');
            if (savedHighContrast === 'true') {
                document.body.classList.add('high-contrast');
            }
            
            // Load saved custom theme
            const savedTheme = localStorage.getItem('aiHub_customTheme');
            if (savedTheme && savedTheme !== 'default') {
                applyTheme(savedTheme);
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    document.getElementById('settings-dropdown').style.display = 'none';
                }
            });
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInUp {
                    from { opacity: 0; transform: translateY(20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
                
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                }
            `;
            document.head.appendChild(style);
            
            // Show welcome message
            if (!localStorage.getItem('aiHub_welcomed')) {
                setTimeout(() => {
                    showToast('Welcome to AI Learning Hub Enhanced! üéâ', 'success', 5000);
                    localStorage.setItem('aiHub_welcomed', 'true');
                }, 1000);
            }
            
            console.log('üöÄ AI Learning Hub Enhanced initialized successfully!');
        });
        
        // ============================================
        // AUTO-SAVE
        // ============================================
        setInterval(() => {
            if (APP_STATE.currentUser) {
                saveAppData('currentUser', APP_STATE.currentUser);
                saveAppData('projects', APP_STATE.projects);
                saveAppData('starred', APP_STATE.starredProjects);
                saveAppData('activityFeed', APP_STATE.activityFeed);
            }
        }, 30000); // Auto-save every 30 seconds
        
        // ============================================
        // SIMULATED REAL-TIME UPDATES
        // ============================================
        setInterval(() => {
            // Simulate random activity
            if (Math.random() < 0.3 && APP_STATE.projects.length > 0) {
                const randomProject = APP_STATE.projects[Math.floor(Math.random() * APP_STATE.projects.length)];
                const activities = [
                    `Someone starred "${randomProject.title}"`,
                    `New comment on "${randomProject.title}"`,
                    `"${randomProject.title}" was updated`
                ];
                const randomActivity = activities[Math.floor(Math.random() * activities.length)];
                
                if (APP_STATE.currentPage === 'home') {
                    addActivityItem('project', randomActivity);
                }
            }
        }, 20000); // Check every 20 seconds
    </script>
    
    <!-- API Integration -->
    <script>
        // Block any cached api-integration.js from loading
        if (typeof API_URL !== 'undefined') {
            console.warn('Detected cached API_URL - clearing it');
            delete window.API_URL;
        }
        
        // Load the new API service file dynamically to bypass cache
        const script = document.createElement('script');
        script.src = 'api-service.js?bust=' + Date.now();
        script.onload = function() {
            console.log('‚úÖ Fresh API service loaded successfully');
        };
        script.onerror = function() {
            console.error('‚ùå Failed to load API service');
        };
        document.head.appendChild(script);
        
        // API Configuration
        window.AI_HUB_API_URL = 'https://ai-learning-hub-api.onrender.com/api';

        // Load discussions with API
        async function loadDiscussionsWithAPI() {
          APP_STATE.discussions = await ApiService.getDiscussions();
          if (APP_STATE.currentPage === 'discussions') renderDiscussions();
        }

        // Load projects with API
        async function loadProjectsWithAPI() {
          APP_STATE.projects = await ApiService.getProjects();
          if (APP_STATE.currentPage === 'projects') renderProjects();
        }

        // Load lessons with API
        async function loadLessonsWithAPI() {
          const lessons = await ApiService.getLessons();
          if (lessons && lessons.length > 0) {
            // Update lessons in APP_STATE if they exist
            if (!APP_STATE.lessons) APP_STATE.lessons = [];
            APP_STATE.lessons = lessons;
            if (APP_STATE.currentPage === 'lessons') renderLessons();
          }
        }

        // Load study rooms with API
        async function loadRoomsWithAPI() {
          const rooms = await ApiService.getRooms();
          if (rooms && rooms.length > 0) {
            // Update rooms in APP_STATE if they exist
            if (!APP_STATE.studyRooms) APP_STATE.studyRooms = [];
            APP_STATE.studyRooms = rooms;
            if (APP_STATE.currentPage === 'collaborate') renderStudyRooms();
          }
        }

        // Load all data from API
        async function loadAllDataFromAPI() {
          await Promise.all([
            loadDiscussionsWithAPI(),
            loadProjectsWithAPI(),
            loadLessonsWithAPI(),
            loadRoomsWithAPI()
          ]);
        }

        // Call this when page loads
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(() => {
            if (typeof APP_STATE !== 'undefined') {
              loadAllDataFromAPI();
            }
          }, 1000);
        });
    </script>
</body>
</html>